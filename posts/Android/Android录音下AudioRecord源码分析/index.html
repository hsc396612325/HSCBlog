<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Android录音下————AudioRecord源码分析 | 冰炭不投day的博客</title>
    <meta property="og:title" content="Android录音下————AudioRecord源码分析 - 冰炭不投day的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2018-07-03T22:40:54&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2018-07-03T22:40:54&#43;08:00'>
        
    <meta name="Keywords" content="Android 冰炭不投day">
    <meta name="description" content="Android录音下————AudioRecord源码分析">
        
    <meta name="author" content="冰炭不投day">
    <meta property="og:url" content="http://blog.bingtan.online/posts/Android/Android%E5%BD%95%E9%9F%B3%E4%B8%8BAudioRecord%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-4031353640611810",
        enable_page_level_ads: true
    });
    </script>
    


    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://blog.bingtan.online">
                        冰炭不投day的博客
                    </a>
                
                <p class="description">若向往 我敢往</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="http://blog.bingtan.online">首页</a>
                    
                    <a  href="http://blog.bingtan.online/tools/" title="工具">工具</a>
                    
                    <a  href="http://blog.bingtan.online/archives/" title="归档">归档</a>
                    
                    <a  href="http://blog.bingtan.online/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Android录音下————AudioRecord源码分析</h1>
        </header>
        <date class="post-meta meta-date">
            2018年7月3日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='http://blog.bingtan.online/categories/Android'>Android</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        

        
        
        <div class="post-content">
            <h3 id="一概述">一.概述</h3>
<p>在上一篇博客中，主要看了AudioRecord的应用。接下来让我们看一看AudioRecord源码的分析。</p>
<p>注：Native层源码版本：android5.1.0</p>
<h4 id="1主要分析点">1.主要分析点</h4>
<p>分析的时候以上一篇博客AudioRecord使用过程中涉及到的方法来进行分析。主要分析下面几个方法：</p>
<ul>
<li>getMinBufferSize:获取AudioRecord对象所需的最小缓冲区大小</li>
<li>new AudioRecord：创建一个AudioRecord对象</li>
<li>startRecording：启动AudioRecord进行录音</li>
<li>read：读取录音数据</li>
<li>stop：停止录音</li>
</ul>
<h4 id="2储备知识">2.储备知识</h4>
<p>Android架构主要分为三层</p>
<ul>
<li>底层 ：linux内核</li>
<li>中间层：主要由c++层实现</li>
<li>应用层：主要由java开发的应用程序</li>
</ul>
<p>应用层和中间层的关联主要是由JNI来实现的，</p>
<p>所以大致过程就是，java应用产生的操作&ndash;&gt;JNI调用中间层&ndash;&gt;如果中间层需要硬件或者低层支持，则调用底层，否则处理完返回给应用层。</p>
<p>在音频通路建立的过程中，需要AndroidBinder相关的概念。
详细内容可见我之前的博客：<a href="https://blog.csdn.net/qq_38499859/article/details/83833539">Android之IPC4————Bander1 概述与Bander驱动</a></p>
<h3 id="二getminbuffersize">二.getMinBufferSize</h3>
<p>getMinBufferSize:获取AudioRecord对象所需的最小缓冲区大小。</p>
<h4 id="1argetminbuffersizejava">1.AR.getMinBufferSize(java)</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">getMinBufferSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> sampleRateInHz<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> channelConfig<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> audioFormat<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#458;font-weight:bold">int</span> channelCount <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span>channelConfig<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">//单声道
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">case</span> AudioFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHANNEL_IN_DEFAULT</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#998;font-style:italic">// AudioFormat.CHANNEL_CONFIGURATION_DEFAULT
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">case</span> AudioFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHANNEL_IN_MONO</span><span style="color:#000;font-weight:bold">:</span>
        <span style="color:#000;font-weight:bold">case</span> AudioFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHANNEL_CONFIGURATION_MONO</span><span style="color:#000;font-weight:bold">:</span>
            channelCount <span style="color:#000;font-weight:bold">=</span> 1<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#998;font-style:italic">//立体声    
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">case</span> AudioFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHANNEL_IN_STEREO</span><span style="color:#000;font-weight:bold">:</span>
        <span style="color:#000;font-weight:bold">case</span> AudioFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHANNEL_CONFIGURATION_STEREO</span><span style="color:#000;font-weight:bold">:</span>
        <span style="color:#000;font-weight:bold">case</span> <span style="color:#000;font-weight:bold">(</span>AudioFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHANNEL_IN_FRONT</span> <span style="color:#000;font-weight:bold">|</span> AudioFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHANNEL_IN_BACK</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">:</span>
            channelCount <span style="color:#000;font-weight:bold">=</span> 2<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">case</span> AudioFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHANNEL_INVALID</span><span style="color:#000;font-weight:bold">:</span>
        <span style="color:#000;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
            loge<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;getMinBufferSize(): Invalid channel configuration.&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">return</span> ERROR_BAD_VALUE<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

		<span style="color:#998;font-style:italic">//调用的jni中的native_get_min_buff_size函数
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#458;font-weight:bold">int</span> size <span style="color:#000;font-weight:bold">=</span> native_get_min_buff_size<span style="color:#000;font-weight:bold">(</span>sampleRateInHz<span style="color:#000;font-weight:bold">,</span> channelCount<span style="color:#000;font-weight:bold">,</span> audioFormat<span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>size <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> ERROR_BAD_VALUE<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>size <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span>1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> ERROR<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> size<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="2argetminbuffersizec">2.AR.getMinBufferSize(c++)</h4>
<p>查看源码可知native_get_min_buff_size实现，是通过JNI函数进入framework/base/core/jni/android_media_AudioRecord.cpp的函数</p>
<p>native_get_min_buff_size函数到cpp中函数关联是通过android_media_AudioRecord.cpp中的函数数组来查看的</p>
<p>路径：framework/base/core/jni/android_media_AudioRecord.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">const</span> JNINativeMethod gMethods[] <span style="color:#000;font-weight:bold">=</span> {
    <span style="color:#998;font-style:italic">// name,               signature,  funcPtr
</span><span style="color:#998;font-style:italic"></span>    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_start</span><span style="color:#d14">&#34;</span>,         <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">(II)I</span><span style="color:#d14">&#34;</span>,    (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_start},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_stop</span><span style="color:#d14">&#34;</span>,          <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">()V</span><span style="color:#d14">&#34;</span>,    (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_stop},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_setup</span><span style="color:#d14">&#34;</span>,         <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">(Ljava/lang/Object;Ljava/lang/Object;[IIIII[ILjava/lang/String;J)I</span><span style="color:#d14">&#34;</span>,
                                      (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_setup},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_finalize</span><span style="color:#d14">&#34;</span>,      <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">()V</span><span style="color:#d14">&#34;</span>,    (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_finalize},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_release</span><span style="color:#d14">&#34;</span>,       <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">()V</span><span style="color:#d14">&#34;</span>,    (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_release},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_read_in_byte_array</span><span style="color:#d14">&#34;</span>,
                             <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">([BIIZ)I</span><span style="color:#d14">&#34;</span>,
                                     (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_readInArray<span style="color:#000;font-weight:bold">&lt;</span>jbyteArray<span style="color:#000;font-weight:bold">&gt;</span>},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_read_in_short_array</span><span style="color:#d14">&#34;</span>,
                             <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">([SIIZ)I</span><span style="color:#d14">&#34;</span>,
                                     (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_readInArray<span style="color:#000;font-weight:bold">&lt;</span>jshortArray<span style="color:#000;font-weight:bold">&gt;</span>},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_read_in_float_array</span><span style="color:#d14">&#34;</span>,
                             <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">([FIIZ)I</span><span style="color:#d14">&#34;</span>,
                                     (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_readInArray<span style="color:#000;font-weight:bold">&lt;</span>jfloatArray<span style="color:#000;font-weight:bold">&gt;</span>},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_read_in_direct_buffer</span><span style="color:#d14">&#34;</span>,<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">(Ljava/lang/Object;IZ)I</span><span style="color:#d14">&#34;</span>,
                                       (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_readInDirectBuffer},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_get_buffer_size_in_frames</span><span style="color:#d14">&#34;</span>,
                             <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">()I</span><span style="color:#d14">&#34;</span>, (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_get_buffer_size_in_frames},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_set_marker_pos</span><span style="color:#d14">&#34;</span>,<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">(I)I</span><span style="color:#d14">&#34;</span>,   (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_set_marker_pos},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_get_marker_pos</span><span style="color:#d14">&#34;</span>,<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">()I</span><span style="color:#d14">&#34;</span>,    (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_get_marker_pos},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_set_pos_update_period</span><span style="color:#d14">&#34;</span>,
                             <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">(I)I</span><span style="color:#d14">&#34;</span>,   (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_set_pos_update_period},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_get_pos_update_period</span><span style="color:#d14">&#34;</span>,
                             <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">()I</span><span style="color:#d14">&#34;</span>,    (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_get_pos_update_period},
<span style="color:#998;font-style:italic">//native_get_min_buff_size--&gt;android_media_AudioRecord_get_min_buff_size
</span><span style="color:#998;font-style:italic"></span>    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_get_min_buff_size</span><span style="color:#d14">&#34;</span>,
                             <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">(III)I</span><span style="color:#d14">&#34;</span>,   (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_get_min_buff_size},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_setInputDevice</span><span style="color:#d14">&#34;</span>, <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">(I)Z</span><span style="color:#d14">&#34;</span>, (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_setInputDevice},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_getRoutedDeviceId</span><span style="color:#d14">&#34;</span>, <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">()I</span><span style="color:#d14">&#34;</span>, (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_getRoutedDeviceId},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_enableDeviceCallback</span><span style="color:#d14">&#34;</span>, <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">()V</span><span style="color:#d14">&#34;</span>, (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_enableDeviceCallback},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_disableDeviceCallback</span><span style="color:#d14">&#34;</span>, <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">()V</span><span style="color:#d14">&#34;</span>,
                                        (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_disableDeviceCallback},
    {<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">native_get_timestamp</span><span style="color:#d14">&#34;</span>, <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">(Landroid/media/AudioTimestamp;I)I</span><span style="color:#d14">&#34;</span>,
                                       (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)android_media_AudioRecord_get_timestamp},
};

</code></pre></td></tr></table>
</div>
</div><p>路径：framework/base/core/jni/android_media_AudioRecord.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">static</span> jint <span style="color:#900;font-weight:bold">android_media_AudioRecord_get_min_buff_size</span>(JNIEnv <span style="color:#000;font-weight:bold">*</span>env,  jobject thiz,
    jint sampleRateInHertz, jint channelCount, jint audioFormat) {

    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">&gt;&gt; android_media_AudioRecord_get_min_buff_size(%d, %d, %d)</span><span style="color:#d14">&#34;</span>,
          sampleRateInHertz, channelCount, audioFormat);

    size_t frameCount <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    audio_format_t format <span style="color:#000;font-weight:bold">=</span> audioFormatToNative(audioFormat);
    <span style="color:#998;font-style:italic">//以传址的方式获取formatCount值。
</span><span style="color:#998;font-style:italic"></span>    status_t result <span style="color:#000;font-weight:bold">=</span> AudioRecord<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>getMinFrameCount(<span style="color:#000;font-weight:bold">&amp;</span>frameCount,
            sampleRateInHertz,
            format,
            audio_channel_in_mask_from_count(channelCount));

    <span style="color:#000;font-weight:bold">if</span> (result <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> BAD_VALUE) {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
    }
    <span style="color:#000;font-weight:bold">if</span> (result <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
    }
    <span style="color:#000;font-weight:bold">return</span> frameCount <span style="color:#000;font-weight:bold">*</span> channelCount <span style="color:#000;font-weight:bold">*</span> audio_bytes_per_sample(format);
}
</code></pre></td></tr></table>
</div>
</div><p>根据最小的frameCount计算的buffersize。frameCount即一秒中有多少个frame。
frame是音频中一个常见单位：表示音乐帧，即采样位数（每个采样数据占用字节大小）*通道数（声音通道的个数）
所以最小buffer= 每秒钟帧数 * 通道数 *采样位数（每个采样数据所占用的字节大小）</p>
<h3 id="三new-audiorecord">三.new AudioRecord</h3>
<h4 id="1arnew-audiorecordjava">1.AR.new AudioRecord(java)</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">AudioRecord</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> audioSource<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> sampleRateInHz<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> channelConfig<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> audioFormat<span style="color:#000;font-weight:bold">,</span>
            <span style="color:#458;font-weight:bold">int</span> bufferSizeInBytes<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">throws</span> IllegalArgumentException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> AudioAttributes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Builder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setInternalCapturePreset</span><span style="color:#000;font-weight:bold">(</span>audioSource<span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> AudioFormat<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Builder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setChannelMask</span><span style="color:#000;font-weight:bold">(</span>getChannelMaskFromLegacyConfig<span style="color:#000;font-weight:bold">(</span>channelConfig<span style="color:#000;font-weight:bold">,</span>
                                        <span style="color:#000;font-weight:bold">true</span><span style="color:#998;font-style:italic">/*allow legacy configurations*/</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setEncoding</span><span style="color:#000;font-weight:bold">(</span>audioFormat<span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSampleRate</span><span style="color:#000;font-weight:bold">(</span>sampleRateInHz<span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">,</span>
                bufferSizeInBytes<span style="color:#000;font-weight:bold">,</span>
                AudioManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">AUDIO_SESSION_ID_GENERATE</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看出这里调用了另一个构造方法
下面的代码中省略了细节</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">AudioRecord</span><span style="color:#000;font-weight:bold">(</span>AudioAttributes attributes<span style="color:#000;font-weight:bold">,</span> AudioFormat format<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> bufferSizeInBytes<span style="color:#000;font-weight:bold">,</span>
            <span style="color:#458;font-weight:bold">int</span> sessionId<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IllegalArgumentException <span style="color:#000;font-weight:bold">{</span>
        mRecordingState <span style="color:#000;font-weight:bold">=</span> RECORDSTATE_STOPPED<span style="color:#000;font-weight:bold">;</span>

		<span style="color:#998;font-style:italic">//获取主线程的looper
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// remember which looper is associated with the AudioRecord instanciation
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">(</span>mInitializationLooper <span style="color:#000;font-weight:bold">=</span> Looper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">myLooper</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            mInitializationLooper <span style="color:#000;font-weight:bold">=</span> Looper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMainLooper</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

       <span style="color:#000;font-weight:bold">.</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000;font-weight:bold">.</span><span style="color:#998;font-style:italic">//各种属性的初始化
</span><span style="color:#998;font-style:italic"></span>
    
         <span style="color:#998;font-style:italic">//调用native层的native_setup，把自己的WeakReference(软引用)传进去
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//TODO: update native initialization when information about hardware init failure
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//      due to capture device already open is available.
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#458;font-weight:bold">int</span> initResult <span style="color:#000;font-weight:bold">=</span> native_setup<span style="color:#000;font-weight:bold">(</span> <span style="color:#000;font-weight:bold">new</span> WeakReference<span style="color:#000;font-weight:bold">&lt;</span>AudioRecord<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">,</span>
                mAudioAttributes<span style="color:#000;font-weight:bold">,</span> sampleRate<span style="color:#000;font-weight:bold">,</span> mChannelMask<span style="color:#000;font-weight:bold">,</span> mChannelIndexMask<span style="color:#000;font-weight:bold">,</span>
                mAudioFormat<span style="color:#000;font-weight:bold">,</span> mNativeBufferSizeInBytes<span style="color:#000;font-weight:bold">,</span>
                session<span style="color:#000;font-weight:bold">,</span> ActivityThread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentOpPackageName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">,</span> 0 <span style="color:#998;font-style:italic">/*nativeRecordInJavaObj*/</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>initResult <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> SUCCESS<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            loge<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Error code &#34;</span><span style="color:#000;font-weight:bold">+</span>initResult<span style="color:#000;font-weight:bold">+</span><span style="color:#d14">&#34; when initializing native AudioRecord object.&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// with mState == STATE_UNINITIALIZED
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>

        mSampleRate <span style="color:#000;font-weight:bold">=</span> sampleRate<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span>
        mSessionId <span style="color:#000;font-weight:bold">=</span> session<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span>

        mState <span style="color:#000;font-weight:bold">=</span> STATE_INITIALIZED<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

</code></pre></td></tr></table>
</div>
</div><h4 id="2arandroid_media_audiorecord_setupc">2.AR.android_media_AudioRecord_setup(c++)</h4>
<p>目录：framework/base/core/jni/android_media_AudioRecord.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">android_media_AudioRecord_setup(JNIEnv <span style="color:#000;font-weight:bold">*</span>env, jobject thiz, jobject weak_this,
        jobject jaa, jint sampleRateInHertz, jint channelMask,
                <span style="color:#998;font-style:italic">// Java channel masks map directly to the native definition
</span><span style="color:#998;font-style:italic"></span>        jint audioFormat, jint buffSizeInBytes, jintArray jSession)
{
  ...
  
    i

    <span style="color:#998;font-style:italic">// create an uninitialized AudioRecord object
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//创建一个未初始化的AudioRecord对象
</span><span style="color:#998;font-style:italic"></span>    sp<span style="color:#000;font-weight:bold">&lt;</span>AudioRecord<span style="color:#000;font-weight:bold">&gt;</span> lpRecorder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AudioRecord();

   ...
    <span style="color:#000;font-weight:bold">const</span> status_t status <span style="color:#000;font-weight:bold">=</span> lpRecorder<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>set(paa<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>source,
        sampleRateInHertz,
        format,        <span style="color:#998;font-style:italic">// word length, PCM
</span><span style="color:#998;font-style:italic"></span>        channelMask,
        frameCount,
        recorderCallback,<span style="color:#998;font-style:italic">// callback_t
</span><span style="color:#998;font-style:italic"></span>        lpCallbackData,<span style="color:#998;font-style:italic">// void* user
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#099">0</span>,             <span style="color:#998;font-style:italic">// notificationFrames,
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#0086b3">true</span>,          <span style="color:#998;font-style:italic">// threadCanCallJava
</span><span style="color:#998;font-style:italic"></span>        sessionId,
        AudioRecord<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>TRANSFER_DEFAULT,
        flags,
        paa);

    <span style="color:#000;font-weight:bold">if</span> (status <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
		<span style="color:#998;font-style:italic">//初始化检查失败
</span><span style="color:#998;font-style:italic"></span>        ALOGE(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Error creating AudioRecord instance: initialization check failed with status %d.</span><span style="color:#d14">&#34;</span>,
                status);
        <span style="color:#000;font-weight:bold">goto</span> native_init_failure;
    }

   ...

 
    <span style="color:#998;font-style:italic">// save our newly created C++ AudioRecord in the &#34;nativeRecorderInJavaObj&#34; field
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// of the Java object
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//将我们新创建的c++ AudioRecord保存在Java对象的“nativeRecorderInJavaObj”字段中
</span><span style="color:#998;font-style:italic"></span>    setAudioRecord(env, thiz, lpRecorder);

    <span style="color:#998;font-style:italic">// save our newly created callback information in the &#34;nativeCallbackCookie&#34; field
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// of the Java object (in mNativeCallbackCookie) so we can free the memory in finalize()
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//将我们新创建的回调信息保存在Java对象的“nativeCallbackCookie”字段中(在mNativeCallbackCookie中)，
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//这样我们就可以在finalize()中释放内存
</span><span style="color:#998;font-style:italic"></span>	env<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>SetLongField(thiz, javaAudioRecordFields.nativeCallbackCookie, (jlong)lpCallbackData);

    <span style="color:#000;font-weight:bold">return</span> (jint) AUDIO_JAVA_SUCCESS;

    <span style="color:#998;font-style:italic">// failure:
</span><span style="color:#998;font-style:italic"></span><span style="color:#900;font-weight:bold">native_init_failure</span>:
    env<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>DeleteGlobalRef(lpCallbackData<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>audioRecord_class);
    env<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>DeleteGlobalRef(lpCallbackData<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>audioRecord_ref);
    <span style="color:#000;font-weight:bold">delete</span> lpCallbackData;
    env<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>SetLongField(thiz, javaAudioRecordFields.nativeCallbackCookie, <span style="color:#099">0</span>);

    <span style="color:#000;font-weight:bold">return</span> (jint) AUDIORECORD_ERROR_SETUP_NATIVEINITFAILED;
}
</code></pre></td></tr></table>
</div>
</div><p>在这个函数里出来大部分的初始化，比较核心的内容主要有：</p>
<ul>
<li>lpRecorder-&gt;set</li>
<li>把刚创建的AudioRecord对象保存在Java层（“nativeRecorderInJavaObj”），通过getAudioRecord函数再获取</li>
<li>回调信息保存在Java对象的“nativeCallbackCookie”字段中</li>
</ul>
<h4 id="3arsetc">3.AR.set(c++)</h4>
<p>android5.1版本AudioRecord
目录：\frameworks\av\media\libmedia\AudioRecord.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">status_t AudioRecord<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>set(
        audio_source_t inputSource,
        uint32_t sampleRate,
        audio_format_t format,
        audio_channel_mask_t channelMask,
        size_t frameCount,
        callback_t cbf,
        <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> user,
        uint32_t notificationFrames,
        <span style="color:#458;font-weight:bold">bool</span> threadCanCallJava,
        <span style="color:#458;font-weight:bold">int</span> sessionId,
        transfer_type transferType,
        audio_input_flags_t flags,
        <span style="color:#000;font-weight:bold">const</span> audio_attributes_t<span style="color:#000;font-weight:bold">*</span> pAttributes)
{
    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">set(): inputSource %d, sampleRate %u, format %#x, channelMask %#x, frameCount %zu, </span><span style="color:#d14">&#34;</span>
          <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">notificationFrames %u, sessionId %d, transferType %d, flags %#x</span><span style="color:#d14">&#34;</span>,
          inputSource, sampleRate, format, channelMask, frameCount, notificationFrames,
          sessionId, transferType, flags);

   ....
   

    mNotificationFramesReq <span style="color:#000;font-weight:bold">=</span> notificationFrames;
    <span style="color:#998;font-style:italic">// mNotificationFramesAct is initialized in openRecord_l
</span><span style="color:#998;font-style:italic"></span>  

    <span style="color:#000;font-weight:bold">if</span> (sessionId <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> AUDIO_SESSION_ALLOCATE) {
        mSessionId <span style="color:#000;font-weight:bold">=</span> AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>newAudioUniqueId();
    } <span style="color:#000;font-weight:bold">else</span> {
        mSessionId <span style="color:#000;font-weight:bold">=</span> sessionId;
    }
    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">set(): mSessionId %d</span><span style="color:#d14">&#34;</span>, mSessionId);

    mFlags <span style="color:#000;font-weight:bold">=</span> flags;
    mCbf <span style="color:#000;font-weight:bold">=</span> cbf;

    <span style="color:#000;font-weight:bold">if</span> (cbf <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
        mAudioRecordThread <span style="color:#000;font-weight:bold">=</span> new AudioRecordThread(<span style="color:#000;font-weight:bold">*</span>this, threadCanCallJava);
        mAudioRecordThread<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>run(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">AudioRecord</span><span style="color:#d14">&#34;</span>, ANDROID_PRIORITY_AUDIO);
    }

    <span style="color:#998;font-style:italic">// create the IAudioRecord
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//创建IAudioRecord
</span><span style="color:#998;font-style:italic"></span>    status_t status <span style="color:#000;font-weight:bold">=</span> openRecord_l(<span style="color:#099">0</span> <span style="color:#998;font-style:italic">/*epoch*/</span>);

    <span style="color:#000;font-weight:bold">if</span> (status <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
        <span style="color:#000;font-weight:bold">if</span> (mAudioRecordThread <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
            mAudioRecordThread<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>requestExit();   <span style="color:#998;font-style:italic">// see comment in AudioRecord.h
</span><span style="color:#998;font-style:italic"></span>            mAudioRecordThread<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>requestExitAndWait();
            mAudioRecordThread.clear();
        }
        <span style="color:#000;font-weight:bold">return</span> status;
    }

    mStatus <span style="color:#000;font-weight:bold">=</span> NO_ERROR;
    mActive <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">false</span>;
    mUserData <span style="color:#000;font-weight:bold">=</span> user;
    <span style="color:#998;font-style:italic">// TODO: add audio hardware input latency here
</span><span style="color:#998;font-style:italic"></span>    mLatency <span style="color:#000;font-weight:bold">=</span> (<span style="color:#099">1000</span><span style="color:#000;font-weight:bold">*</span>mFrameCount) <span style="color:#000;font-weight:bold">/</span> sampleRate;
    mMarkerPosition <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    mMarkerReached <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">false</span>;
    mNewPosition <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    mUpdatePeriod <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>acquireAudioSessionId(mSessionId, <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>);
    mSequence <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
    mObservedSequence <span style="color:#000;font-weight:bold">=</span> mSequence;
    mInOverrun <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">false</span>;

    <span style="color:#000;font-weight:bold">return</span> NO_ERROR;
}
</code></pre></td></tr></table>
</div>
</div><p>继续追踪openRecord_l
目录：\frameworks\av\media\libmedia\AudioRecord.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#998;font-style:italic">// must be called with mLock held
</span><span style="color:#998;font-style:italic"></span>status_t AudioRecord<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>openRecord_l(size_t epoch)
{
    status_t status;
    <span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IAudioFlinger<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> audioFlinger <span style="color:#000;font-weight:bold">=</span> AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>get_audio_flinger();
   ...
    audio_io_handle_t input;
    status <span style="color:#000;font-weight:bold">=</span> AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>getInputForAttr(<span style="color:#000;font-weight:bold">&amp;</span>mAttributes, <span style="color:#000;font-weight:bold">&amp;</span>input, (audio_session_t)mSessionId,
                                        mSampleRate, mFormat, mChannelMask, mFlags);

    <span style="color:#000;font-weight:bold">if</span> (status <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
        ALOGE(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Could not get audio input for record source %d, sample rate %u, format %#x, </span><span style="color:#d14">&#34;</span>
              <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">channel mask %#x, session %d, flags %#x</span><span style="color:#d14">&#34;</span>,
              mAttributes.source, mSampleRate, mFormat, mChannelMask, mSessionId, mFlags);
        <span style="color:#000;font-weight:bold">return</span> BAD_VALUE;
    }
    {
    <span style="color:#998;font-style:italic">// Now that we have a reference to an I/O handle and have not yet handed it off to AudioFlinger,
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// we must release it ourselves if anything goes wrong.
</span><span style="color:#998;font-style:italic"></span>
	<span style="color:#998;font-style:italic">//现在我们有了一个I/O句柄的引用，但还没有将它交给AudioFlinger，
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//如果出了什么问题，我们必须自己解决。
</span><span style="color:#998;font-style:italic"></span>    size_t frameCount <span style="color:#000;font-weight:bold">=</span> mReqFrameCount;
    size_t temp <span style="color:#000;font-weight:bold">=</span> frameCount;   <span style="color:#998;font-style:italic">// temp may be replaced by a revised value of frameCount,
</span><span style="color:#998;font-style:italic"></span>                                <span style="color:#998;font-style:italic">// but we will still need the original value also
</span><span style="color:#998;font-style:italic"></span>								<span style="color:#998;font-style:italic">//temp可以替换为修改后的frameCount值，
</span><span style="color:#998;font-style:italic"></span>								<span style="color:#998;font-style:italic">//但是我们仍然需要原始值
</span><span style="color:#998;font-style:italic"></span>								
    <span style="color:#458;font-weight:bold">int</span> originalSessionId <span style="color:#000;font-weight:bold">=</span> mSessionId;

    <span style="color:#998;font-style:italic">// The notification frame count is the period between callbacks, as suggested by the server.
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//通知帧计数是服务器建议的回调之间的周期。
</span><span style="color:#998;font-style:italic"></span>	size_t notificationFrames <span style="color:#000;font-weight:bold">=</span> mNotificationFramesReq;

    sp<span style="color:#000;font-weight:bold">&lt;</span>IMemory<span style="color:#000;font-weight:bold">&gt;</span> iMem;           <span style="color:#998;font-style:italic">// for cblk
</span><span style="color:#998;font-style:italic"></span>    sp<span style="color:#000;font-weight:bold">&lt;</span>IMemory<span style="color:#000;font-weight:bold">&gt;</span> bufferMem;
    sp<span style="color:#000;font-weight:bold">&lt;</span>IAudioRecord<span style="color:#000;font-weight:bold">&gt;</span> record <span style="color:#000;font-weight:bold">=</span> audioFlinger<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>openRecord(input,
                                                       mSampleRate, mFormat,
                                                       mChannelMask,
                                                       <span style="color:#000;font-weight:bold">&amp;</span>temp,
                                                       <span style="color:#000;font-weight:bold">&amp;</span>trackFlags,
                                                       tid,
                                                       <span style="color:#000;font-weight:bold">&amp;</span>mSessionId,
                                                       <span style="color:#000;font-weight:bold">&amp;</span>notificationFrames,
                                                       iMem,
                                                       bufferMem,
                                                       <span style="color:#000;font-weight:bold">&amp;</span>status);
    ALOGE_IF(originalSessionId <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> AUDIO_SESSION_ALLOCATE <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> mSessionId <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> originalSessionId,
            <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">session ID changed from %d to %d</span><span style="color:#d14">&#34;</span>, originalSessionId, mSessionId);

  ...

 

    <span style="color:#998;font-style:italic">// Starting address of buffers in shared memory.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// The buffers are either immediately after the control block,
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// or in a separate area at discretion of server.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//共享内存中缓冲区的起始地址。
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//缓冲区要么紧接在控制块之后，
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//或在另一个由服务器决定的区域。
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>buffers;
    <span style="color:#000;font-weight:bold">if</span> (bufferMem <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
        buffers <span style="color:#000;font-weight:bold">=</span> cblk <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>;
    } <span style="color:#000;font-weight:bold">else</span> {
        buffers <span style="color:#000;font-weight:bold">=</span> bufferMem<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>pointer();
        <span style="color:#000;font-weight:bold">if</span> (buffers <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
            ALOGE(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Could not get buffer pointer</span><span style="color:#d14">&#34;</span>);
            <span style="color:#000;font-weight:bold">return</span> NO_INIT;
        }
    }

    <span style="color:#998;font-style:italic">// invariant that mAudioRecord != 0 is true only after set() returns successfully
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//只有在set()成功返回后，mAudioRecord != 0才为true的不变式
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (mAudioRecord <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
        mAudioRecord<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>asBinder()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>unlinkToDeath(mDeathNotifier, <span style="color:#000;font-weight:bold">this</span>);
        mDeathNotifier.clear();
    }
    mAudioRecord <span style="color:#000;font-weight:bold">=</span> record;
    mCblkMemory <span style="color:#000;font-weight:bold">=</span> iMem;
    mBufferMemory <span style="color:#000;font-weight:bold">=</span> bufferMem;
    IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>flushCommands();

    mCblk <span style="color:#000;font-weight:bold">=</span> cblk;
    <span style="color:#998;font-style:italic">// note that temp is the (possibly revised) value of frameCount
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//注意，temp是frameCount的值(可能经过了修改)
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (temp <span style="color:#000;font-weight:bold">&lt;</span> frameCount <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">|</span> (frameCount <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> temp <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>)) {o00
        <span style="color:#900;font-weight:bold">ALOGW</span>(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Requested frameCount %zu but received frameCount %zu</span><span style="color:#d14">&#34;</span>, frameCount, temp);
    }
    frameCount <span style="color:#000;font-weight:bold">=</span> temp;

    mAwaitBoost <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">false</span>;
    <span style="color:#000;font-weight:bold">if</span> (mFlags <span style="color:#000;font-weight:bold">&amp;</span> AUDIO_INPUT_FLAG_FAST) {
        <span style="color:#000;font-weight:bold">if</span> (trackFlags <span style="color:#000;font-weight:bold">&amp;</span> IAudioFlinger<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>TRACK_FAST) {
            ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">AUDIO_INPUT_FLAG_FAST successful; frameCount %zu</span><span style="color:#d14">&#34;</span>, frameCount);
            mAwaitBoost <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">true</span>;
        } <span style="color:#000;font-weight:bold">else</span> {
            ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">AUDIO_INPUT_FLAG_FAST denied by server; frameCount %zu</span><span style="color:#d14">&#34;</span>, frameCount);
            <span style="color:#998;font-style:italic">// once denied, do not request again if IAudioRecord is re-created
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">//一旦被拒绝，如果重新创建IAudioRecord，则不要再次请求
</span><span style="color:#998;font-style:italic"></span>            mFlags <span style="color:#000;font-weight:bold">=</span> (audio_input_flags_t) (mFlags <span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">~</span>AUDIO_INPUT_FLAG_FAST);
        }
    }

    <span style="color:#998;font-style:italic">// Make sure that application is notified with sufficient margin before overrun
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//确保在超限前通知应用程序有足够的余量
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (notificationFrames <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">|</span> notificationFrames <span style="color:#000;font-weight:bold">&gt;</span> frameCount) {
        ALOGW(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Received notificationFrames %zu for frameCount %zu</span><span style="color:#d14">&#34;</span>, notificationFrames, frameCount);
    }
    mNotificationFramesAct <span style="color:#000;font-weight:bold">=</span> notificationFrames;

    <span style="color:#998;font-style:italic">// We retain a copy of the I/O handle, but don&#39;t own the reference
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//我们保留了I/O句柄的副本，但不拥有引用
</span><span style="color:#998;font-style:italic"></span>    mInput <span style="color:#000;font-weight:bold">=</span> input;
    mRefreshRemaining <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">true</span>;

    mFrameCount <span style="color:#000;font-weight:bold">=</span> frameCount;
    <span style="color:#998;font-style:italic">// If IAudioRecord is re-created, don&#39;t let the requested frameCount
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// decrease.  This can confuse clients that cache frameCount().
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//如果IAudioRecord被重新创建，不要让请求的frameCount减少。这可能会使缓存frameCount()的客户机感到困惑。
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (frameCount <span style="color:#000;font-weight:bold">&gt;</span> mReqFrameCount) {
        mReqFrameCount <span style="color:#000;font-weight:bold">=</span> frameCount;
    }

    <span style="color:#998;font-style:italic">// update proxy
</span><span style="color:#998;font-style:italic"></span>    mProxy <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AudioRecordClientProxy(cblk, buffers, mFrameCount, mFrameSize);
    mProxy<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>setEpoch(epoch);
    mProxy<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>setMinimum(mNotificationFramesAct);

    mDeathNotifier <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DeathNotifier(<span style="color:#000;font-weight:bold">this</span>);
    mAudioRecord<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>asBinder()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>linkToDeath(mDeathNotifier, <span style="color:#000;font-weight:bold">this</span>);

    <span style="color:#000;font-weight:bold">return</span> NO_ERROR;
    }

<span style="color:#900;font-weight:bold">release</span>:
    AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>releaseInput(input, (audio_session_t)mSessionId);
    <span style="color:#000;font-weight:bold">if</span> (status <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
        status <span style="color:#000;font-weight:bold">=</span> NO_INIT;
    }
    <span style="color:#000;font-weight:bold">return</span> status;
}
</code></pre></td></tr></table>
</div>
</div><p>比较重要的几行代码</p>
<ul>
<li>audioFlinger = AudioSystem::get_audio_flinger();</li>
<li>record = audioFlinger-&gt;openRecord</li>
<li>mAudioR09ecord = record;</li>
</ul>
<p>下面主要分析AudioSystem::get_audio_flinger()和audioFlinger-&gt;openRecord</p>
<h4 id="4asget_audio_flingerc">4.AS.get_audio_flinger(c++)</h4>
<p>目录：\frameworks\av\media\libmedia\AudioSystem</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IAudioFlinger<span style="color:#000;font-weight:bold">&gt;</span> AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>get_audio_flinger()
{
    sp<span style="color:#000;font-weight:bold">&lt;</span>IAudioFlinger<span style="color:#000;font-weight:bold">&gt;</span> af;
    sp<span style="color:#000;font-weight:bold">&lt;</span>AudioFlingerClient<span style="color:#000;font-weight:bold">&gt;</span> afc;
    {
        Mutex<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>Autolock _l(gLock);
        <span style="color:#000;font-weight:bold">if</span> (gAudioFlinger <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
            sp<span style="color:#000;font-weight:bold">&lt;</span>IServiceManager<span style="color:#000;font-weight:bold">&gt;</span> sm <span style="color:#000;font-weight:bold">=</span> defaultServiceManager();
            sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span> binder;
            <span style="color:#000;font-weight:bold">do</span> {
                binder <span style="color:#000;font-weight:bold">=</span> sm<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getService(String16(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">media.audio_flinger</span><span style="color:#d14">&#34;</span>));
                <span style="color:#000;font-weight:bold">if</span> (binder <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>)
                    <span style="color:#000;font-weight:bold">break</span>;
                ALOGW(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">AudioFlinger not published, waiting...</span><span style="color:#d14">&#34;</span>);
                usleep(<span style="color:#099">500000</span>); <span style="color:#998;font-style:italic">// 0.5 s
</span><span style="color:#998;font-style:italic"></span>            } <span style="color:#000;font-weight:bold">while</span> (<span style="color:#0086b3">true</span>);
            <span style="color:#000;font-weight:bold">if</span> (gAudioFlingerClient <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
                gAudioFlingerClient <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AudioFlingerClient();
            } <span style="color:#000;font-weight:bold">else</span> {
                <span style="color:#000;font-weight:bold">if</span> (gAudioErrorCallback) {
                    gAudioErrorCallback(NO_ERROR);
                }
            }
            binder<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>linkToDeath(gAudioFlingerClient);
            gAudioFlinger <span style="color:#000;font-weight:bold">=</span> interface_cast<span style="color:#000;font-weight:bold">&lt;</span>IAudioFlinger<span style="color:#000;font-weight:bold">&gt;</span>(binder);
            LOG_ALWAYS_FATAL_IF(gAudioFlinger <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>);
            afc <span style="color:#000;font-weight:bold">=</span> gAudioFlingerClient;
        }
        af <span style="color:#000;font-weight:bold">=</span> gAudioFlinger;
    }
    <span style="color:#000;font-weight:bold">if</span> (afc <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
        af<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>registerClient(afc);
    }
    <span style="color:#000;font-weight:bold">return</span> af;
}

</code></pre></td></tr></table>
</div>
</div><p>上面是一段很典型的利用binder的ipc</p>
<ul>
<li>sm = defaultServiceManager()获取SM</li>
<li>binder = sm-&gt;getService(String16(&ldquo;media.audio_flinger&rdquo;));获取对应的服务</li>
<li>gAudioFlinger = interface_cast<!-- raw HTML omitted -->(binder)获取IAF对象，并将binder传入其中。</li>
</ul>
<p>接下来我们继续追踪IAF.openRecord</p>
<h4 id="5iafopenrecordc">5.IAF.openRecord(c++)</h4>
<p>目录：\frameworks\av\media\libmedia\IAudioFlinger</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">virtual</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IAudioRecord<span style="color:#000;font-weight:bold">&gt;</span> openRecord(
                                audio_io_handle_t input,
                                <span style="color:#458;font-weight:bold">uint32_t</span> sampleRate,
                                audio_format_t format,
                                audio_channel_mask_t channelMask,
                                size_t <span style="color:#000;font-weight:bold">*</span>pFrameCount,
                                track_flags_t <span style="color:#000;font-weight:bold">*</span>flags,
                                pid_t tid,
                                <span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>sessionId,
                                size_t <span style="color:#000;font-weight:bold">*</span>notificationFrames,
                                sp<span style="color:#000;font-weight:bold">&lt;</span>IMemory<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> cblk,
                                sp<span style="color:#000;font-weight:bold">&lt;</span>IMemory<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> buffers,
                                status_t <span style="color:#000;font-weight:bold">*</span>status)
    {
        Parcel data, reply;
        sp<span style="color:#000;font-weight:bold">&lt;</span>IAudioRecord<span style="color:#000;font-weight:bold">&gt;</span> record;
        data.writeInterfaceToken(IAudioFlinger<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>getInterfaceDescriptor());
        ...data传输数据
        data.writeInt64(notificationFrames <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">notificationFrames</span> : <span style="color:#099">0</span>);
        cblk.clear();
        buffers.clear();
        status_t lStatus <span style="color:#000;font-weight:bold">=</span> remote()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>transact(OPEN_RECORD, data, <span style="color:#000;font-weight:bold">&amp;</span>reply);
        <span style="color:#000;font-weight:bold">if</span> (lStatus <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
            ALOGE(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">openRecord error: %s</span><span style="color:#d14">&#34;</span>, strerror(<span style="color:#000;font-weight:bold">-</span>lStatus));
        } <span style="color:#000;font-weight:bold">else</span> {
           ...
            record <span style="color:#000;font-weight:bold">=</span> interface_cast<span style="color:#000;font-weight:bold">&lt;</span>IAudioRecord<span style="color:#000;font-weight:bold">&gt;</span>(reply.readStrongBinder());
            cblk <span style="color:#000;font-weight:bold">=</span> interface_cast<span style="color:#000;font-weight:bold">&lt;</span>IMemory<span style="color:#000;font-weight:bold">&gt;</span>(reply.readStrongBinder());
           ...
        }
        
        <span style="color:#000;font-weight:bold">return</span> record;
    }
</code></pre></td></tr></table>
</div>
</div><p>重点分析</p>
<ul>
<li>data传输数据</li>
<li>remote()-&gt;transact调用远端Service进行ipc</li>
<li>record = interface_cast<!-- raw HTML omitted --> 获取远端返回的结果</li>
</ul>
<h4 id="6afopenrecordc">6.AF.openRecord(c++)</h4>
<p>目录：frameworks/av/services/audioflinger/AudioFlinger.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#000;font-weight:bold">&lt;</span>IAudioRecord<span style="color:#000;font-weight:bold">&gt;</span> AudioFlinger<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>openRecord(
        audio_io_handle_t input,
        <span style="color:#458;font-weight:bold">uint32_t</span> sampleRate,
        audio_format_t format,
        audio_channel_mask_t channelMask,
        size_t <span style="color:#000;font-weight:bold">*</span>frameCount,
        IAudioFlinger<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>track_flags_t <span style="color:#000;font-weight:bold">*</span>flags,
        pid_t tid,
        <span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>sessionId,
        size_t <span style="color:#000;font-weight:bold">*</span>notificationFrames,
        sp<span style="color:#000;font-weight:bold">&lt;</span>IMemory<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> cblk,
        sp<span style="color:#000;font-weight:bold">&lt;</span>IMemory<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> buffers,
        status_t <span style="color:#000;font-weight:bold">*</span>status)
{
    sp<span style="color:#000;font-weight:bold">&lt;</span>RecordThread<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>RecordTrack<span style="color:#000;font-weight:bold">&gt;</span> recordTrack;
    sp<span style="color:#000;font-weight:bold">&lt;</span>RecordHandle<span style="color:#000;font-weight:bold">&gt;</span> recordHandle;
    sp<span style="color:#000;font-weight:bold">&lt;</span>Client<span style="color:#000;font-weight:bold">&gt;</span> client;
    status_t lStatus;
    <span style="color:#458;font-weight:bold">int</span> lSessionId;

    cblk.clear();
    buffers.clear();

   ...

    {
        Mutex<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>Autolock _l(mLock);
        RecordThread <span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">thread</span> <span style="color:#000;font-weight:bold">=</span> checkRecordThread_l(input);
        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">thread</span> <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
            ALOGE(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">openRecord() checkRecordThread_l failed</span><span style="color:#d14">&#34;</span>);
            lStatus <span style="color:#000;font-weight:bold">=</span> BAD_VALUE;
            <span style="color:#000;font-weight:bold">goto</span> Exit;
        }

        pid_t pid <span style="color:#000;font-weight:bold">=</span> IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getCallingPid();
       ...
        <span style="color:#998;font-style:italic">// TODO: the uid should be passed in as a parameter to openRecord
</span><span style="color:#998;font-style:italic"></span>        recordTrack <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>createRecordTrack_l(client, sampleRate, format, channelMask,
                                                  frameCount, lSessionId, notificationFrames,
                                                  IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getCallingUid(),
                                                  flags, tid, <span style="color:#000;font-weight:bold">&amp;</span>lStatus);
        LOG_ALWAYS_FATAL_IF((lStatus <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> (recordTrack <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>));

       
    }

   ...
    cblk <span style="color:#000;font-weight:bold">=</span> recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getCblk();
    buffers <span style="color:#000;font-weight:bold">=</span> recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getBuffers();

    <span style="color:#998;font-style:italic">// return handle to client
</span><span style="color:#998;font-style:italic"></span>    recordHandle <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> RecordHandle(recordTrack);

<span style="color:#900;font-weight:bold">Exit</span>:
    <span style="color:#000;font-weight:bold">*</span>status <span style="color:#000;font-weight:bold">=</span> lStatus;
    <span style="color:#000;font-weight:bold">return</span> recordHandle;
}

</code></pre></td></tr></table>
</div>
</div><p>重点分析：</p>
<ul>
<li>RecordThread *thread = checkRecordThread_l(input)</li>
<li>recordTrack = thread-&gt;createRecordTrack_l（&hellip;）</li>
<li>recordHandle = new RecordHandle(recordTrack)</li>
</ul>
<p>所以最终返回的RecordHandle里面包含RecordTrack，然后在其中有包含RecordThread</p>
<h4 id="7流程梳理">7.流程梳理</h4>
<ul>
<li>java new AR&ndash;&gt;AR..android_media_AudioRecord_setup&ndash;&gt;AR.set&ndash;&gt;AR.openRecord_l</li>
<li>在AR.openRecord_l中调用AS.get_audio_flinger获取AF的binder</li>
<li>在AR.openRecord_l通过AF.openRecord获得一个sp<!-- raw HTML omitted -->，包含RecordHandle&ndash;&gt;RecordTrack&ndash;&gt;RecordThread</li>
<li>将上面的sp<!-- raw HTML omitted -->赋值给mAudioRecord</li>
</ul>
<h3 id="四-startrecording">四. startRecording</h3>
<p>上面是创建AudioRecord对象的大部分源码，接下来我们看看startRecording过程</p>
<h4 id="1arstartrecordingjava">1.AR.startRecording(java)</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">startRecording</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">throws</span> IllegalStateException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>mState <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> STATE_INITIALIZED<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;startRecording() called on an &#34;</span>
                    <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;uninitialized AudioRecord.&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#998;font-style:italic">// start recording
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">synchronized</span><span style="color:#000;font-weight:bold">(</span>mRecordingStateLock<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>native_start<span style="color:#000;font-weight:bold">(</span>MediaSyncEvent<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SYNC_EVENT_NONE</span><span style="color:#000;font-weight:bold">,</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> SUCCESS<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                handleFullVolumeRec<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
                mRecordingState <span style="color:#000;font-weight:bold">=</span> RECORDSTATE_RECORDING<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

</code></pre></td></tr></table>
</div>
</div><p>这里没什么说的直接调用的Native层的代码</p>
<h4 id="2arstartrecordingc">2.AR.startRecording(c++)</h4>
<p>目录：\frameworks\av\media\libmedia\AudioRecord.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">android_media_AudioRecord_start(JNIEnv <span style="color:#000;font-weight:bold">*</span>env, jobject thiz, jint event, jint triggerSession)
{
    sp<span style="color:#000;font-weight:bold">&lt;</span>AudioRecord<span style="color:#000;font-weight:bold">&gt;</span> lpRecorder <span style="color:#000;font-weight:bold">=</span> getAudioRecord(env, thiz);
    <span style="color:#000;font-weight:bold">if</span> (lpRecorder <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span> ) {
        jniThrowException(env, <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">java/lang/IllegalStateException</span><span style="color:#d14">&#34;</span>, <span style="color:#0086b3">NULL</span>);
        <span style="color:#000;font-weight:bold">return</span> (jint) AUDIO_JAVA_ERROR;
    }

    <span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">nativeToJavaStatus</span>(
            lpRecorder<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>start((AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>sync_event_t)event, triggerSession));
}
</code></pre></td></tr></table>
</div>
</div><h4 id="3arstartc">3.AR.start(c++)</h4>
<p>目录：\frameworks\av\media\libmedia\AudioRecord.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t AudioRecord<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>start(AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>sync_event_t event, <span style="color:#458;font-weight:bold">int</span> triggerSession)
{
    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">start, sync event %d trigger session %d</span><span style="color:#d14">&#34;</span>, event, triggerSession);

    AutoMutex <span style="color:#900;font-weight:bold">lock</span>(mLock);
    <span style="color:#000;font-weight:bold">if</span> (mActive) {
        <span style="color:#000;font-weight:bold">return</span> NO_ERROR;
    }

    <span style="color:#998;font-style:italic">// reset current position as seen by client to 0
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//将客户端看到的当前位置重置为0
</span><span style="color:#998;font-style:italic"></span>    mProxy<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>setEpoch(mProxy<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getEpoch() <span style="color:#000;font-weight:bold">-</span> mProxy<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getPosition());
    <span style="color:#998;font-style:italic">//使用processAudioBuffer()强制刷新剩余帧，因为在停止之前的最后一次读取可能是局部的。
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// force refresh of remaining frames by processAudioBuffer() as last
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// read before stop could be partial.
</span><span style="color:#998;font-style:italic"></span>    mRefreshRemaining <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">true</span>;

    mNewPosition <span style="color:#000;font-weight:bold">=</span> mProxy<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getPosition() <span style="color:#000;font-weight:bold">+</span> mUpdatePeriod;
    <span style="color:#458;font-weight:bold">int32_t</span> flags <span style="color:#000;font-weight:bold">=</span> android_atomic_acquire_load(<span style="color:#000;font-weight:bold">&amp;</span>mCblk<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mFlags);

    status_t status <span style="color:#000;font-weight:bold">=</span> NO_ERROR;
    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>(flags <span style="color:#000;font-weight:bold">&amp;</span> CBLK_INVALID)) {
        ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">mAudioRecord-&gt;start()</span><span style="color:#d14">&#34;</span>);
        status <span style="color:#000;font-weight:bold">=</span> mAudioRecord<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>start(event, triggerSession);
        <span style="color:#000;font-weight:bold">if</span> (status <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> DEAD_OBJECT) {
            flags <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">=</span> CBLK_INVALID;
        }
    }
    <span style="color:#000;font-weight:bold">if</span> (flags <span style="color:#000;font-weight:bold">&amp;</span> CBLK_INVALID) {
        status <span style="color:#000;font-weight:bold">=</span> restoreRecord_l(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">start</span><span style="color:#d14">&#34;</span>);
    }

    <span style="color:#000;font-weight:bold">if</span> (status <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
        ALOGE(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">start() status %d</span><span style="color:#d14">&#34;</span>, status);
    } <span style="color:#000;font-weight:bold">else</span> {
        mActive <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">true</span>;
        sp<span style="color:#000;font-weight:bold">&lt;</span>AudioRecordThread<span style="color:#000;font-weight:bold">&gt;</span> t <span style="color:#000;font-weight:bold">=</span> mAudioRecordThread;
        <span style="color:#000;font-weight:bold">if</span> (t <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
            t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>resume();
        } <span style="color:#000;font-weight:bold">else</span> {
            mPreviousPriority <span style="color:#000;font-weight:bold">=</span> getpriority(PRIO_PROCESS, <span style="color:#099">0</span>);
            get_sched_policy(<span style="color:#099">0</span>, <span style="color:#000;font-weight:bold">&amp;</span>mPreviousSchedulingGroup);
            androidSetThreadPriority(<span style="color:#099">0</span>, ANDROID_PRIORITY_AUDIO);
        }
    }

    <span style="color:#000;font-weight:bold">return</span> status;
}
</code></pre></td></tr></table>
</div>
</div><p>在这里最关键的一行代码 status = mAudioRecord-&gt;start(event, triggerSession);
关于mAudioRecord变量在上一节我们有提过</p>
<p>所以： mAudioRecord.start&ndash;&gt;RecordHandle.start&ndash;&gt;RecordTrack.start&ndash;&gt;RecordThread.start</p>
<h4 id="4rtstartc">4.RT.start(c++)</h4>
<p>目录：frameworks/av/services/audioflinger/Threads.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t AudioFlinger<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>RecordThread<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>start(RecordThread<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>RecordTrack<span style="color:#000;font-weight:bold">*</span> recordTrack,
                                           AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>sync_event_t event,
                                           <span style="color:#458;font-weight:bold">int</span> triggerSession)
{
    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">RecordThread::start event %d, triggerSession %d</span><span style="color:#d14">&#34;</span>, event, triggerSession);
    sp<span style="color:#000;font-weight:bold">&lt;</span>ThreadBase<span style="color:#000;font-weight:bold">&gt;</span> strongMe <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span>;
    status_t status <span style="color:#000;font-weight:bold">=</span> NO_ERROR;

    <span style="color:#000;font-weight:bold">if</span> (event <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>SYNC_EVENT_NONE) {
        recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>clearSyncStartEvent();
    } <span style="color:#000;font-weight:bold">else</span> <span style="color:#900;font-weight:bold">if</span> (event <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>SYNC_EVENT_SAME) {
        recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mSyncStartEvent <span style="color:#000;font-weight:bold">=</span> mAudioFlinger<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>createSyncEvent(event,
                                       triggerSession,
                                       recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>sessionId(),
                                       syncStartEventCallback,
                                       recordTrack);
        <span style="color:#998;font-style:italic">// Sync event can be cancelled by the trigger session if the track is not in a
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// compatible state in which case we start record immediately
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mSyncStartEvent<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>isCancelled()) {
            recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>clearSyncStartEvent();
        } <span style="color:#000;font-weight:bold">else</span> {
            <span style="color:#998;font-style:italic">// do not wait for the event for more than AudioSystem::kSyncRecordStartTimeOutMs
</span><span style="color:#998;font-style:italic"></span>            recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mFramesToDrop <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span>
                    ((AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>kSyncRecordStartTimeOutMs <span style="color:#000;font-weight:bold">*</span> recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mSampleRate) <span style="color:#000;font-weight:bold">/</span> <span style="color:#099">1000</span>);
        }
    }

    {
        <span style="color:#998;font-style:italic">// This section is a rendezvous between binder thread executing start() and RecordThread
</span><span style="color:#998;font-style:italic"></span>        AutoMutex <span style="color:#900;font-weight:bold">lock</span>(mLock);
        <span style="color:#000;font-weight:bold">if</span> (mActiveTracks.indexOf(recordTrack) <span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
            <span style="color:#000;font-weight:bold">if</span> (recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mState <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> TrackBase<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>PAUSING) {
                ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">active record track PAUSING -&gt; ACTIVE</span><span style="color:#d14">&#34;</span>);
                recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mState <span style="color:#000;font-weight:bold">=</span> TrackBase<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>ACTIVE;
            } <span style="color:#000;font-weight:bold">else</span> {
                ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">active record track state %d</span><span style="color:#d14">&#34;</span>, recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mState);
            }
            <span style="color:#000;font-weight:bold">return</span> status;
        }

        <span style="color:#998;font-style:italic">// TODO consider other ways of handling this, such as changing the state to :STARTING and
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//      adding the track to mActiveTracks after returning from AudioSystem::startInput(),
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//      or using a separate command thread
</span><span style="color:#998;font-style:italic"></span>        recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mState <span style="color:#000;font-weight:bold">=</span> TrackBase<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>STARTING_1;
        mActiveTracks.add(recordTrack);
        mActiveTracksGen<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>;
        status_t status <span style="color:#000;font-weight:bold">=</span> NO_ERROR;
        <span style="color:#000;font-weight:bold">if</span> (recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>isExternalTrack()) {
            mLock.unlock();
            status <span style="color:#000;font-weight:bold">=</span> AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>startInput(mId, (audio_session_t)recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>sessionId());
            mLock.lock();
            <span style="color:#998;font-style:italic">// FIXME should verify that recordTrack is still in mActiveTracks
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> (status <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
                mActiveTracks.remove(recordTrack);
                mActiveTracksGen<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>;
                recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>clearSyncStartEvent();
                ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">RecordThread::start error %d</span><span style="color:#d14">&#34;</span>, status);
                <span style="color:#000;font-weight:bold">return</span> status;
            }
        }
        <span style="color:#998;font-style:italic">// Catch up with current buffer indices if thread is already running.
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// This is what makes a new client discard all buffered data.  If the track&#39;s mRsmpInFront
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// was initialized to some value closer to the thread&#39;s mRsmpInFront, then the track could
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// see previously buffered data before it called start(), but with greater risk of overrun.
</span><span style="color:#998;font-style:italic"></span>
        recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mRsmpInFront <span style="color:#000;font-weight:bold">=</span> mRsmpInRear;
        recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mRsmpInUnrel <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
        <span style="color:#998;font-style:italic">// FIXME why reset?
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mResampler <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
            recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mResampler<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>reset();
        }
        recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mState <span style="color:#000;font-weight:bold">=</span> TrackBase<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>STARTING_2;
        <span style="color:#998;font-style:italic">// signal thread to start
</span><span style="color:#998;font-style:italic"></span>        mWaitWorkCV.broadcast();
        <span style="color:#000;font-weight:bold">if</span> (mActiveTracks.indexOf(recordTrack) <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">0</span>) {
            ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Record failed to start</span><span style="color:#d14">&#34;</span>);
            status <span style="color:#000;font-weight:bold">=</span> BAD_VALUE;
            <span style="color:#000;font-weight:bold">goto</span> startError;
        }
        <span style="color:#000;font-weight:bold">return</span> status;
    }

<span style="color:#900;font-weight:bold">startError</span>:
    <span style="color:#000;font-weight:bold">if</span> (recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>isExternalTrack()) {
        AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>stopInput(mId, (audio_session_t)recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>sessionId());
    }
    recordTrack<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>clearSyncStartEvent();
    <span style="color:#998;font-style:italic">// FIXME I wonder why we do not reset the state here?
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> status;
}
</code></pre></td></tr></table>
</div>
</div><p>继续追踪AudioSystem::startInput</p>
<h4 id="5asstartinputc">5.AS.startInput(c++)</h4>
<p>目录：\frameworks\av\media\libmedia\AudioSystem</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>startInput(audio_io_handle_t input,
                                 audio_session_t session)
{
    <span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IAudioPolicyService<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> aps <span style="color:#000;font-weight:bold">=</span> AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>get_audio_policy_service();
    <span style="color:#000;font-weight:bold">if</span> (aps <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">return</span> PERMISSION_DENIED;
    <span style="color:#000;font-weight:bold">return</span> aps<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>startInput(input, session);
}
</code></pre></td></tr></table>
</div>
</div><p>AudioSystem::get_audio_policy_service()的过程和上面的二.4中的代码内容差不多。都是获取一个IAudioPolicyService对象，在这个对象中有binder。</p>
<p>IAudioPolicyService.startInput会去通过binder调用AudioPolicyService.startInput，所以我们继续看AudioPolicyService.startInput</p>
<h4 id="6apsstartinputc">6.APS.startInput(c++)</h4>
<p>在AudioPolicyService.cpp,并没有找到startInput,然后在同目录下的AudioPolicyIntefaceImpl.cpp,找到其实现。</p>
<p>目录: frameworks/av/services/audiopolicy/AudioPolicyIntefaceImpl.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t AudioPolicyService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>startInput(audio_io_handle_t input,
                                        audio_session_t session)
{
    <span style="color:#000;font-weight:bold">if</span> (mAudioPolicyManager <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
        <span style="color:#000;font-weight:bold">return</span> NO_INIT;
    }
    Mutex<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>Autolock _l(mLock);

    <span style="color:#000;font-weight:bold">return</span> mAudioPolicyManager<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>startInput(input, session);
}

</code></pre></td></tr></table>
</div>
</div><p>在AudioPolicyService.h中找到mAudioPolicyManager的变量类型</p>
<blockquote>
<p>AudioPolicyInterface *mAudioPolicyManager;</p>
</blockquote>
<p>而AudioPolicyInterface实际上由不同的平台各自实现的。当然也有默认的。
这个类的作用是：</p>
<ul>
<li>跟踪当前系统状态（可移动设备连接、电话状态、用户请求…）。系统状态更改和用户操作将通过audiopolicyInterface的方法通知音频策略管理器。</li>
<li>创建audioTrack对象时接收的process getoutput（）</li>
<li>同样处理从音频记录对象接收的getinput（）和putinput（）查询，并配置音频输入。</li>
</ul>
<p>在这里我们看看Android默认实现的类</p>
<p>ps:这一块的源码真不好理，加上我半吊子的c++水平&hellip;..</p>
<h4 id="7apmbstartinputc">7.APMB.startInput(c++)</h4>
<p>目录：hardware/libhardware_legacy/audio/AudioPolicyManagerBase.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t AudioPolicyManagerBase<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>startInput(audio_io_handle_t input)
{
    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">startInput() input %d</span><span style="color:#d14">&#34;</span>, input);
    ssize_t index <span style="color:#000;font-weight:bold">=</span> mInputs.indexOfKey(input);
    <span style="color:#000;font-weight:bold">if</span> (index <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">0</span>) {
        ALOGW(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">startInput() unknown input %d</span><span style="color:#d14">&#34;</span>, input);
        <span style="color:#000;font-weight:bold">return</span> BAD_VALUE;
    }
    AudioInputDescriptor <span style="color:#000;font-weight:bold">*</span>inputDesc <span style="color:#000;font-weight:bold">=</span> mInputs.valueAt(index);

<span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">ifdef AUDIO_POLICY_TEST</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (mTestInput <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>)
<span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">endif </span><span style="color:#998;font-style:italic">//AUDIO_POLICY_TEST
</span><span style="color:#998;font-style:italic"></span>    {
        <span style="color:#998;font-style:italic">// refuse 2 active AudioRecord clients at the same time except if the active input
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// uses AUDIO_SOURCE_HOTWORD in which case it is closed.
</span><span style="color:#998;font-style:italic"></span>        audio_io_handle_t activeInput <span style="color:#000;font-weight:bold">=</span> getActiveInput();
        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>isVirtualInputDevice(inputDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mDevice) <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> activeInput <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
            AudioInputDescriptor <span style="color:#000;font-weight:bold">*</span>activeDesc <span style="color:#000;font-weight:bold">=</span> mInputs.valueFor(activeInput);
            <span style="color:#000;font-weight:bold">if</span> (activeDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mInputSource <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> AUDIO_SOURCE_HOTWORD) {
                ALOGW(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">startInput() preempting already started low-priority input %d</span><span style="color:#d14">&#34;</span>, activeInput);
                stopInput(activeInput);
                releaseInput(activeInput);
            } <span style="color:#000;font-weight:bold">else</span> {
                ALOGW(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">startInput() input %d failed: other input already started</span><span style="color:#d14">&#34;</span>, input);
                <span style="color:#000;font-weight:bold">return</span> INVALID_OPERATION;
            }
        }
    }

    audio_devices_t newDevice <span style="color:#000;font-weight:bold">=</span> getDeviceForInputSource(inputDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mInputSource);
    <span style="color:#000;font-weight:bold">if</span> ((newDevice <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> AUDIO_DEVICE_NONE) <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> (newDevice <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> inputDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mDevice)) {
        inputDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mDevice <span style="color:#000;font-weight:bold">=</span> newDevice;
    }

    <span style="color:#998;font-style:italic">// automatically enable the remote submix output when input is started
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//启动输入时自动启用远程子混合输出
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (audio_is_remote_submix_device(inputDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mDevice)) {
        setDeviceConnectionState(AUDIO_DEVICE_OUT_REMOTE_SUBMIX,
                AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>DEVICE_STATE_AVAILABLE, AUDIO_REMOTE_SUBMIX_DEVICE_ADDRESS);
    }

    AudioParameter param <span style="color:#000;font-weight:bold">=</span> AudioParameter();
    param.addInt(String8(AudioParameter<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>keyRouting), (<span style="color:#458;font-weight:bold">int</span>)inputDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mDevice);

    <span style="color:#458;font-weight:bold">int</span> aliasSource <span style="color:#000;font-weight:bold">=</span> (inputDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mInputSource <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> AUDIO_SOURCE_HOTWORD) <span style="color:#000;font-weight:bold">?</span>
                                        <span style="color:#900;font-weight:bold">AUDIO_SOURCE_VOICE_RECOGNITION</span> : inputDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mInputSource;

    param.addInt(String8(AudioParameter<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>keyInputSource), aliasSource);
    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">AudioPolicyManager::startInput() input source = %d</span><span style="color:#d14">&#34;</span>, inputDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mInputSource);

    mpClientInterface<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>setParameters(input, param.toString());

    inputDesc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mRefCount <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
    <span style="color:#000;font-weight:bold">return</span> NO_ERROR;
}
</code></pre></td></tr></table>
</div>
</div><p>好了，我们看的最后面调用的mpClientInterface-&gt;setParameters(input, param.toString());</p>
<p>mpClientInterface的是 AudioPolicyClientInterface</p>
<p>所以继续追踪APC.setParameters
目录：frameworks/av/services/audiopolicy/AudioPolicyClientInterface</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#458;font-weight:bold">void</span> AudioPolicyService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>AudioPolicyClient<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>setParameters(audio_io_handle_t io_handle,
                   <span style="color:#000;font-weight:bold">const</span> String8<span style="color:#000;font-weight:bold">&amp;</span> keyValuePairs,
                   <span style="color:#458;font-weight:bold">int</span> delay_ms)
{
    mAudioPolicyService<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>setParameters(io_handle, keyValuePairs.string(), delay_ms);
}
</code></pre></td></tr></table>
</div>
</div><p>继续追踪APS.setParameters</p>
<h4 id="8-apssetparametersc">8. APS.setParameters(c++)</h4>
<p>目录：frameworks/av/services/audiopolicy/AudioPolicyService.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#458;font-weight:bold">void</span> AudioPolicyService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>setParameters(audio_io_handle_t ioHandle,
                                       <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>keyValuePairs,
                                       <span style="color:#458;font-weight:bold">int</span> delayMs)
{
    mAudioCommandThread<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>parametersCommand(ioHandle, keyValuePairs,
                                           delayMs);
}
</code></pre></td></tr></table>
</div>
</div><p>追踪 mAudioCommandThread-&gt;parametersCommand
还是在这个文件下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t AudioPolicyService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>AudioCommandThread<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>parametersCommand(audio_io_handle_t ioHandle,
                                                                   <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>keyValuePairs,
                                                                   <span style="color:#458;font-weight:bold">int</span> delayMs)
{
    sp<span style="color:#000;font-weight:bold">&lt;</span>AudioCommand<span style="color:#000;font-weight:bold">&gt;</span> command <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AudioCommand();
    command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand <span style="color:#000;font-weight:bold">=</span> SET_PARAMETERS;
    sp<span style="color:#000;font-weight:bold">&lt;</span>ParametersData<span style="color:#000;font-weight:bold">&gt;</span> data <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ParametersData();
    data<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mIO <span style="color:#000;font-weight:bold">=</span> ioHandle;
    data<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mKeyValuePairs <span style="color:#000;font-weight:bold">=</span> String8(keyValuePairs);
    command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mParam <span style="color:#000;font-weight:bold">=</span> data;
    command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mWaitStatus <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">true</span>;
    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">AudioCommandThread() adding set parameter string %s, io %d ,delay %d</span><span style="color:#d14">&#34;</span>,
            keyValuePairs, ioHandle, delayMs);
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">sendCommand</span>(command, delayMs);
}

</code></pre></td></tr></table>
</div>
</div><p>可以看到，在这里启动线程，并将SET_PARAMETERS指令传过去</p>
<p>继续追踪sendCommand
还是在这个文件下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t AudioPolicyService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>AudioCommandThread<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>sendCommand(sp<span style="color:#000;font-weight:bold">&lt;</span>AudioCommand<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> command, <span style="color:#458;font-weight:bold">int</span> delayMs)
{
    {
        Mutex<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>Autolock _l(mLock);
        insertCommand_l(command, delayMs);
        mWaitWorkCV.signal();
    }
    Mutex<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>Autolock _l(command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mLock);
    <span style="color:#000;font-weight:bold">while</span> (command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mWaitStatus) {
        nsecs_t timeOutNs <span style="color:#000;font-weight:bold">=</span> kAudioCommandTimeoutNs <span style="color:#000;font-weight:bold">+</span> milliseconds(delayMs);
        <span style="color:#000;font-weight:bold">if</span> (command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCond.waitRelative(command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mLock, timeOutNs) <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
            command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mStatus <span style="color:#000;font-weight:bold">=</span> TIMED_OUT;
            command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mWaitStatus <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">false</span>;
        }
    }
    <span style="color:#000;font-weight:bold">return</span> command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mStatus;
}

</code></pre></td></tr></table>
</div>
</div><p>在这里面进行了加锁操作
同时调用了 insertCommand_l（）函数
继续追踪</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">97
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">/</span> insertCommand_l() must be called with mLock held
<span style="color:#458;font-weight:bold">void</span> AudioPolicyService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>AudioCommandThread<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>insertCommand_l(sp<span style="color:#000;font-weight:bold">&lt;</span>AudioCommand<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> command, <span style="color:#458;font-weight:bold">int</span> delayMs)
{
    ssize_t i;  <span style="color:#998;font-style:italic">// not size_t because i will count down to -1
</span><span style="color:#998;font-style:italic"></span>    Vector <span style="color:#000;font-weight:bold">&lt;</span> sp<span style="color:#000;font-weight:bold">&lt;</span>AudioCommand<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">&gt;</span> removedCommands;
    command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mTime <span style="color:#000;font-weight:bold">=</span> systemTime() <span style="color:#000;font-weight:bold">+</span> milliseconds(delayMs);

    <span style="color:#998;font-style:italic">// acquire wake lock to make sure delayed commands are processed
</span><span style="color:#998;font-style:italic"></span>  	<span style="color:#998;font-style:italic">//获取唤醒锁以确保已处理延迟的命令   
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (mAudioCommands.isEmpty()) {
        acquire_wake_lock(PARTIAL_WAKE_LOCK, mName.string());
    }

    <span style="color:#998;font-style:italic">// check same pending commands with later time stamps and eliminate them
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//用以后的时间戳检查相同的挂起命令并消除它们
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">for</span> (i <span style="color:#000;font-weight:bold">=</span> mAudioCommands.size()<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>; i <span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">-</span>) {
        sp<span style="color:#000;font-weight:bold">&lt;</span>AudioCommand<span style="color:#000;font-weight:bold">&gt;</span> command2 <span style="color:#000;font-weight:bold">=</span> mAudioCommands[i];
        <span style="color:#998;font-style:italic">// commands are sorted by increasing time stamp: no need to scan the rest of mAudioCommands
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (command2<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mTime <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">=</span> command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mTime) <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#998;font-style:italic">// create audio patch or release audio patch commands are equivalent
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// with regard to filtering
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> ((command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> CREATE_AUDIO_PATCH) <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">|</span>
                (command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> RELEASE_AUDIO_PATCH)) {
            <span style="color:#000;font-weight:bold">if</span> ((command2<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> CREATE_AUDIO_PATCH) <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span>
                    (command2<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> RELEASE_AUDIO_PATCH)) {
                <span style="color:#000;font-weight:bold">continue</span>;
            }
        } <span style="color:#000;font-weight:bold">else</span> <span style="color:#900;font-weight:bold">if</span> (command2<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand) <span style="color:#000;font-weight:bold">continue</span>;

        <span style="color:#000;font-weight:bold">switch</span> (command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand) {
        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SET_PARAMETERS</span>: {
            ParametersData <span style="color:#000;font-weight:bold">*</span>data <span style="color:#000;font-weight:bold">=</span> (ParametersData <span style="color:#000;font-weight:bold">*</span>)command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mParam.get();
            ParametersData <span style="color:#000;font-weight:bold">*</span>data2 <span style="color:#000;font-weight:bold">=</span> (ParametersData <span style="color:#000;font-weight:bold">*</span>)command2<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mParam.get();
            <span style="color:#000;font-weight:bold">if</span> (data<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mIO <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> data2<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mIO) <span style="color:#000;font-weight:bold">break</span>;
            ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Comparing parameter command %s to new command %s</span><span style="color:#d14">&#34;</span>,
                    data2<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mKeyValuePairs.string(), data<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mKeyValuePairs.string());
            AudioParameter param <span style="color:#000;font-weight:bold">=</span> AudioParameter(data<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mKeyValuePairs);
            AudioParameter param2 <span style="color:#000;font-weight:bold">=</span> AudioParameter(data2<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mKeyValuePairs);
            <span style="color:#000;font-weight:bold">for</span> (size_t j <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; j <span style="color:#000;font-weight:bold">&lt;</span> param.size(); j<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>) {
                String8 key;
                String8 value;
                param.getAt(j, key, value);
                <span style="color:#000;font-weight:bold">for</span> (size_t k <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; k <span style="color:#000;font-weight:bold">&lt;</span> param2.size(); k<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>) {
                    String8 key2;
                    String8 value2;
                    param2.getAt(k, key2, value2);
                    <span style="color:#000;font-weight:bold">if</span> (key2 <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> key) {
                        param2.remove(key2);
                        ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Filtering out parameter %s</span><span style="color:#d14">&#34;</span>, key2.string());
                        <span style="color:#000;font-weight:bold">break</span>;
                    }
                }
            }
            <span style="color:#998;font-style:italic">// if all keys have been filtered out, remove the command.
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">// otherwise, update the key value pairs
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">///如果已筛选出所有键，则删除该命令。
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">//否则，更新键值对
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> (param2.size() <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
                removedCommands.add(command2);
            } <span style="color:#000;font-weight:bold">else</span> {
                data2<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mKeyValuePairs <span style="color:#000;font-weight:bold">=</span> param2.toString();
            }
            command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mTime <span style="color:#000;font-weight:bold">=</span> command2<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mTime;
            <span style="color:#998;font-style:italic">// force delayMs to non 0 so that code below does not request to wait for
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">// command status as the command is now delayed
</span><span style="color:#998;font-style:italic"></span>            delayMs <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
        } <span style="color:#000;font-weight:bold">break</span>;

        ...<span style="color:#a61717;background-color:#e3d2d2">其</span><span style="color:#a61717;background-color:#e3d2d2">他</span><span style="color:#a61717;background-color:#e3d2d2">指</span><span style="color:#a61717;background-color:#e3d2d2">令</span>...
    }

    <span style="color:#998;font-style:italic">// remove filtered commands
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">for</span> (size_t j <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; j <span style="color:#000;font-weight:bold">&lt;</span> removedCommands.size(); j<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>) {
        <span style="color:#998;font-style:italic">// removed commands always have time stamps greater than current command
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">for</span> (size_t k <span style="color:#000;font-weight:bold">=</span> i <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>; k <span style="color:#000;font-weight:bold">&lt;</span> mAudioCommands.size(); k<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>) {
            <span style="color:#000;font-weight:bold">if</span> (mAudioCommands[k].get() <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> removedCommands[j].get()) {
                ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">suppressing command: %d</span><span style="color:#d14">&#34;</span>, mAudioCommands[k]<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand);
                mAudioCommands.removeAt(k);
                <span style="color:#000;font-weight:bold">break</span>;
            }
        }
    }
    removedCommands.clear();

    <span style="color:#998;font-style:italic">// Disable wait for status if delay is not 0.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// Except for create audio patch command because the returned patch handle
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// is needed by audio policy manager
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (delayMs <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> CREATE_AUDIO_PATCH) {
        command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mWaitStatus <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">false</span>;
    }

    <span style="color:#998;font-style:italic">// insert command at the right place according to its time stamp
</span><span style="color:#998;font-style:italic"></span>    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">inserting command: %d at index %zd, num commands %zu</span><span style="color:#d14">&#34;</span>,
            command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand, i<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>, mAudioCommands.size());
    mAudioCommands.insertAt(command, i <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>);
}
</code></pre></td></tr></table>
</div>
</div><p>在这个函数里，将SET_PARAMETERS指令放入SET_PARAMETERS。我们继续来看，他是在什么地方执行该指令的</p>
<p>在threadLoop函数中</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">ool AudioPolicyService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>AudioCommandThread<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>threadLoop()
{
    nsecs_t waitTime <span style="color:#000;font-weight:bold">=</span> INT64_MAX;

    mLock.lock();
    <span style="color:#000;font-weight:bold">while</span> (<span style="color:#000;font-weight:bold">!</span>exitPending())
    {
        sp<span style="color:#000;font-weight:bold">&lt;</span>AudioPolicyService<span style="color:#000;font-weight:bold">&gt;</span> svc;
        <span style="color:#000;font-weight:bold">while</span> (<span style="color:#000;font-weight:bold">!</span>mAudioCommands.isEmpty() <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">!</span>exitPending()) {
            nsecs_t curTime <span style="color:#000;font-weight:bold">=</span> systemTime();
            <span style="color:#998;font-style:italic">// commands are sorted by increasing time stamp: execute them from index 0 and up
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> (mAudioCommands[<span style="color:#099">0</span>]<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mTime <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">=</span> curTime) {
                sp<span style="color:#000;font-weight:bold">&lt;</span>AudioCommand<span style="color:#000;font-weight:bold">&gt;</span> command <span style="color:#000;font-weight:bold">=</span> mAudioCommands[<span style="color:#099">0</span>];
                mAudioCommands.removeAt(<span style="color:#099">0</span>);
                mLastCommand <span style="color:#000;font-weight:bold">=</span> command;

                <span style="color:#000;font-weight:bold">switch</span> (command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mCommand) {
              ...<span style="color:#a61717;background-color:#e3d2d2">其</span><span style="color:#a61717;background-color:#e3d2d2">他</span><span style="color:#a61717;background-color:#e3d2d2">指</span><span style="color:#a61717;background-color:#e3d2d2">令</span>
                <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SET_PARAMETERS</span>: {
                    ParametersData <span style="color:#000;font-weight:bold">*</span>data <span style="color:#000;font-weight:bold">=</span> (ParametersData <span style="color:#000;font-weight:bold">*</span>)command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mParam.get();
                    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">AudioCommandThread() processing set parameters string %s, io %d</span><span style="color:#d14">&#34;</span>,
                            data<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mKeyValuePairs.string(), data<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mIO);
                    command<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mStatus <span style="color:#000;font-weight:bold">=</span> AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>setParameters(data<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mIO, data<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mKeyValuePairs);
                    }<span style="color:#000;font-weight:bold">break</span>;
             ...<span style="color:#a61717;background-color:#e3d2d2">其</span><span style="color:#a61717;background-color:#e3d2d2">他</span><span style="color:#a61717;background-color:#e3d2d2">指</span><span style="color:#a61717;background-color:#e3d2d2">令</span>
        }
        <span style="color:#998;font-style:italic">// release mLock before releasing strong reference on the service as
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// AudioPolicyService destructor calls AudioCommandThread::exit() which acquires mLock.
</span><span style="color:#998;font-style:italic"></span>        mLock.unlock();
        svc.clear();
        mLock.lock();
        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>exitPending() <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> mAudioCommands.isEmpty()) {
            <span style="color:#998;font-style:italic">// release delayed commands wake lock
</span><span style="color:#998;font-style:italic"></span>            release_wake_lock(mName.string());
            ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">AudioCommandThread() going to sleep</span><span style="color:#d14">&#34;</span>);
            mWaitWorkCV.waitRelative(mLock, waitTime);
            ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">AudioCommandThread() waking up</span><span style="color:#d14">&#34;</span>);
        }
    }
    <span style="color:#998;font-style:italic">// release delayed commands wake lock before quitting
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>mAudioCommands.isEmpty()) {
        release_wake_lock(mName.string());
    }
    mLock.unlock();
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">false</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>好的，在这里我们看到调用了AudioSystem::setParameters方法，继续追踪</p>
<h4 id="9assetparametersc">9.AS.setParameters(c++)</h4>
<p>目录：frameworks\av\media\libmedia\AudioSystem</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>setParameters(audio_io_handle_t ioHandle, <span style="color:#000;font-weight:bold">const</span> String8<span style="color:#000;font-weight:bold">&amp;</span> keyValuePairs)
{
    <span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IAudioFlinger<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> af <span style="color:#000;font-weight:bold">=</span> AudioSystem<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>get_audio_flinger();
    <span style="color:#000;font-weight:bold">if</span> (af <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">return</span> PERMISSION_DENIED;
    <span style="color:#000;font-weight:bold">return</span> af<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>setParameters(ioHandle, keyValuePairs);
}
</code></pre></td></tr></table>
</div>
</div><p>af = AudioSystem::get_audio_flinger(); 这行代码就很熟悉了，获取IAudioFlinger，其中包含bindr。</p>
<h4 id="10afsetparametersc">10.AF.setParameters(c++)</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t AudioFlinger<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>setParameters(audio_io_handle_t ioHandle, <span style="color:#000;font-weight:bold">const</span> String8<span style="color:#000;font-weight:bold">&amp;</span> keyValuePairs)
{
    ALOGV(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">setParameters(): io %d, keyvalue %s, calling pid %d</span><span style="color:#d14">&#34;</span>,
            ioHandle, keyValuePairs.string(), IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getCallingPid());

    <span style="color:#998;font-style:italic">// check calling permissions
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>settingsAllowed()) {
        <span style="color:#000;font-weight:bold">return</span> PERMISSION_DENIED;
    }

    <span style="color:#998;font-style:italic">// AUDIO_IO_HANDLE_NONE means the parameters are global to the audio hardware interface
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (ioHandle <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> AUDIO_IO_HANDLE_NONE) {
        Mutex<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>Autolock _l(mLock);
        status_t final_result <span style="color:#000;font-weight:bold">=</span> NO_ERROR;
        {
            AutoMutex <span style="color:#900;font-weight:bold">lock</span>(mHardwareLock);
            mHardwareStatus <span style="color:#000;font-weight:bold">=</span> AUDIO_HW_SET_PARAMETER;
            <span style="color:#000;font-weight:bold">for</span> (size_t i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> mAudioHwDevs.size(); i<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>) {
                audio_hw_device_t <span style="color:#000;font-weight:bold">*</span>dev <span style="color:#000;font-weight:bold">=</span> mAudioHwDevs.valueAt(i)<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>hwDevice();
                status_t result <span style="color:#000;font-weight:bold">=</span> dev<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>set_parameters(dev, keyValuePairs.string());
                final_result <span style="color:#000;font-weight:bold">=</span> result <span style="color:#000;font-weight:bold">?</span><span style="color:#000;font-weight:bold">:</span> final_result;
            }
            mHardwareStatus <span style="color:#000;font-weight:bold">=</span> AUDIO_HW_IDLE;
        }
        <span style="color:#998;font-style:italic">// disable AEC and NS if the device is a BT SCO headset supporting those pre processings
</span><span style="color:#998;font-style:italic"></span>        AudioParameter param <span style="color:#000;font-weight:bold">=</span> AudioParameter(keyValuePairs);
        String8 value;
        <span style="color:#000;font-weight:bold">if</span> (param.get(String8(AUDIO_PARAMETER_KEY_BT_NREC), value) <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
            <span style="color:#458;font-weight:bold">bool</span> btNrecIsOff <span style="color:#000;font-weight:bold">=</span> (value <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> AUDIO_PARAMETER_VALUE_OFF);
            <span style="color:#000;font-weight:bold">if</span> (mBtNrecIsOff <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> btNrecIsOff) {
                <span style="color:#000;font-weight:bold">for</span> (size_t i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> mRecordThreads.size(); i<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>) {
                    sp<span style="color:#000;font-weight:bold">&lt;</span>RecordThread<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">thread</span> <span style="color:#000;font-weight:bold">=</span> mRecordThreads.valueAt(i);
                    audio_devices_t device <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>inDevice();
                    <span style="color:#458;font-weight:bold">bool</span> suspend <span style="color:#000;font-weight:bold">=</span> audio_is_bluetooth_sco_device(device) <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> btNrecIsOff;
                    <span style="color:#998;font-style:italic">// collect all of the thread&#39;s session IDs
</span><span style="color:#998;font-style:italic"></span>                    KeyedVector<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">int</span>, <span style="color:#458;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">&gt;</span> ids <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>sessionIds();
                    <span style="color:#998;font-style:italic">// suspend effects associated with those session IDs
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#000;font-weight:bold">for</span> (size_t j <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; j <span style="color:#000;font-weight:bold">&lt;</span> ids.size(); <span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>j) {
                        <span style="color:#458;font-weight:bold">int</span> sessionId <span style="color:#000;font-weight:bold">=</span> ids.keyAt(j);
                        <span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>setEffectSuspended(FX_IID_AEC,
                                                   suspend,
                                                   sessionId);
                        <span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>setEffectSuspended(FX_IID_NS,
                                                   suspend,
                                                   sessionId);
                    }
                }
                mBtNrecIsOff <span style="color:#000;font-weight:bold">=</span> btNrecIsOff;
            }
        }
        String8 screenState;
        <span style="color:#000;font-weight:bold">if</span> (param.get(String8(AudioParameter<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>keyScreenState), screenState) <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
            <span style="color:#458;font-weight:bold">bool</span> isOff <span style="color:#000;font-weight:bold">=</span> screenState <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">off</span><span style="color:#d14">&#34;</span>;
            <span style="color:#000;font-weight:bold">if</span> (isOff <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> (AudioFlinger<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>mScreenState <span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#099">1</span>)) {
                AudioFlinger<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>mScreenState <span style="color:#000;font-weight:bold">=</span> ((AudioFlinger<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>mScreenState <span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">~</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>) <span style="color:#000;font-weight:bold">|</span> isOff;
            }
        }
        <span style="color:#000;font-weight:bold">return</span> final_result;
    }

    <span style="color:#998;font-style:italic">// hold a strong ref on thread in case closeOutput() or closeInput() is called
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// and the thread is exited once the lock is released
</span><span style="color:#998;font-style:italic"></span>    sp<span style="color:#000;font-weight:bold">&lt;</span>ThreadBase<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">thread</span>;
    {
        Mutex<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>Autolock _l(mLock);
        <span style="color:#000;font-weight:bold">thread</span> <span style="color:#000;font-weight:bold">=</span> checkPlaybackThread_l(ioHandle);
        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">thread</span> <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
            <span style="color:#000;font-weight:bold">thread</span> <span style="color:#000;font-weight:bold">=</span> checkRecordThread_l(ioHandle);
        } <span style="color:#000;font-weight:bold">else</span> <span style="color:#900;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">thread</span> <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> primaryPlaybackThread_l()) {
            <span style="color:#998;font-style:italic">// indicate output device change to all input threads for pre processing
</span><span style="color:#998;font-style:italic"></span>            AudioParameter param <span style="color:#000;font-weight:bold">=</span> AudioParameter(keyValuePairs);
            <span style="color:#458;font-weight:bold">int</span> value;
            <span style="color:#000;font-weight:bold">if</span> ((param.getInt(String8(AudioParameter<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>keyRouting), value) <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span>
                    (value <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>)) {
                <span style="color:#000;font-weight:bold">for</span> (size_t i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> mRecordThreads.size(); i<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>) {
                    mRecordThreads.valueAt(i)<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>setParameters(keyValuePairs);
                }
            }
        }
    }
    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">thread</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>setParameters(keyValuePairs);
    }
    <span style="color:#000;font-weight:bold">return</span> BAD_VALUE;
}
</code></pre></td></tr></table>
</div>
</div><p>在AF.setParameters()的两个参数里，AudioParameter::keyRouting是音频策略管理器和AudioParameter::keyInputSource选定的输入设备参数。</p>
<p>此时通过队列发送命令，交给另一个线程处理。之后交回调用硬件适配层（HAL）的音频硬件。即接口AudioHardwareInterface的子类，由硬件平台厂家实现.</p>
<h4 id="11流程梳理">11.流程梳理</h4>
<p>AR.startRecord
&ndash;&gt;AR.startRecording(c++)
&ndash;&gt;AR.start&ndash;&gt;RecordHandle::start
&ndash;&gt;RecordTrack::start
&ndash;&gt; RecordHandle::start</p>
<p>&ndash;&gt;RecordTrack::start
&ndash;&gt;RecordThread::start</p>
<p>&ndash;&gt;AudioSystem::startInput
&ndash;&gt;AudioPolicyService::startInput
&ndash;&gt;AudioPolicyManagerBase(或厂家自己的管理器)::startInput
&ndash;&gt;AudioFlinger::setParameters
&ndash;&gt;AudioPolicyService::setParameters
&ndash;&gt;异步（通过向队列发送命令，然后由另一个线程去处理）</p>
<p>&ndash;&gt;硬件适配层（HAL）的音频硬件（接口 AudioHardwareInterface的子类，由硬件平台厂家实现）</p>
<p>AudioRecord运行在应用程序进程中，AudioFlinger和AudioPolicyService运行在mediaserver进程中。应用程序调用到AudioFlinger，然后由AudioPolicyService确定输入设备，并将其作为设置到音频硬件中，进行相应的切换。</p>
<p>上面的切换完成后.
在应用程序侧的AudioRecord的start函数中会让其线程ClientRecordThread开始工作。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">....
 androidSetThreadPriority(<span style="color:#099">0</span>, ANDROID_PRIORITY_AUDIO);
</code></pre></td></tr></table>
</div>
</div><p>在AudioFlinger中，录音线程的start函数（RecordThread::start）需要发送信号唤醒正在mWaitWorkCV上等待的线程循环，开始录音工作。录音线程循环进入睡眠等待的代码片段如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">mWaitWorkCV.wait(mLock);<span style="color:#998;font-style:italic">//等待
</span><span style="color:#998;font-style:italic"></span>LOGV(<span style="color:#a61717;background-color:#e3d2d2">“</span><span style="color:#900;font-weight:bold">RecordThread</span>: loop starting<span style="color:#a61717;background-color:#e3d2d2">”</span>);
<span style="color:#000;font-weight:bold">continue</span>;


LOGV(<span style="color:#a61717;background-color:#e3d2d2">“</span>Signal record <span style="color:#000;font-weight:bold">thread</span><span style="color:#a61717;background-color:#e3d2d2">”</span>);
mWaitWorkCV.signal();<span style="color:#998;font-style:italic">//在切换完输入设备后，唤醒线程
</span></code></pre></td></tr></table>
</div>
</div><p>录音线程RecordThread的线程循环函数threadLoop比较复杂，要考虑单声道和双声道，要考虑16位还是8位的PCM数据，还要考虑是否需要重采样等因素。但总体原理是，使用HAL中的音频输入流AudioStreamIn的read函数读取音频数据数据到缓冲区mRsmpInBuffer：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">  <span style="color:#998;font-style:italic">// otherwise use the HAL / AudioStreamIn directly
</span><span style="color:#998;font-style:italic"></span>ssize_t bytesRead <span style="color:#000;font-weight:bold">=</span> mInput<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>stream<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>read(mInput<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>stream, <span style="color:#000;font-weight:bold">&amp;</span>mRsmpInBuffer[rear <span style="color:#000;font-weight:bold">*</span> mChannelCount], mBufferSize);
</code></pre></td></tr></table>
</div>
</div><h3 id="五read">五.read</h3>
<h4 id="1android_media_audiorecord_readinbytearray">1.android_media_AudioRecord_readInByteArray</h4>
<p>前面的没什么可说的，
read → native_read_in_short_array → android_media_AudioRecord_readInByteArray:
直接看android_media_AudioRecord_readInByteArray中的实现
目录:目录：framework/base/core/jni/android_media_AudioRecord.cpp</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">static</span> jint <span style="color:#900;font-weight:bold">android_media_AudioRecord_readInByteArray</span>(JNIEnv <span style="color:#000;font-weight:bold">*</span>env,  jobject thiz,
                                                        jbyteArray javaAudioData,
                                                        jint offsetInBytes, jint sizeInBytes) {
    jbyte<span style="color:#000;font-weight:bold">*</span> recordBuff <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>;
    <span style="color:#998;font-style:italic">// get the audio recorder from which we&#39;ll read new audio samples
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//拿起录音机，我们将从里面读取新的音频样本
</span><span style="color:#998;font-style:italic"></span>    sp<span style="color:#000;font-weight:bold">&lt;</span>AudioRecord<span style="color:#000;font-weight:bold">&gt;</span> lpRecorder <span style="color:#000;font-weight:bold">=</span> getAudioRecord(env, thiz);
    <span style="color:#000;font-weight:bold">if</span> (lpRecorder <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
        ALOGE(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Unable to retrieve AudioRecord object, can&#39;t record</span><span style="color:#d14">&#34;</span>);
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
    }

    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>javaAudioData) {
        ALOGE(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Invalid Java array to store recorded audio, can&#39;t record</span><span style="color:#d14">&#34;</span>);
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
    }

    <span style="color:#998;font-style:italic">// get the pointer to where we&#39;ll record the audio
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// NOTE: We may use GetPrimitiveArrayCritical() when the JNI implementation changes in such
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// a way that it becomes much more efficient. When doing so, we will have to prevent the
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// AudioSystem callback to be called while in critical section (in case of media server
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// process crash for instance)
</span><span style="color:#998;font-style:italic"></span>    
    <span style="color:#998;font-style:italic">////把指针指向我们录制音频的地方
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//注意:当JNI实现以一种更有效的方式发生变化时，我们可能会使用getprimartivearraycritical()。
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//这样做时，我们必须防止在关键部分调用AudioSystem回调(例如在媒体服务器进程崩溃的情况下)
</span><span style="color:#998;font-style:italic"></span>    recordBuff <span style="color:#000;font-weight:bold">=</span> (jbyte <span style="color:#000;font-weight:bold">*</span>)env<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>GetByteArrayElements(javaAudioData, <span style="color:#0086b3">NULL</span>);

    <span style="color:#000;font-weight:bold">if</span> (recordBuff <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
        ALOGE(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Error retrieving destination for recorded audio data, can&#39;t record</span><span style="color:#d14">&#34;</span>);
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
    }

    <span style="color:#998;font-style:italic">// read the new audio data from the native AudioRecord object
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//从本机AudioRecord对象读取新的音频数据
</span><span style="color:#998;font-style:italic"></span>    ssize_t recorderBuffSize <span style="color:#000;font-weight:bold">=</span> lpRecorder<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>frameCount()<span style="color:#000;font-weight:bold">*</span>lpRecorder<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>frameSize();
    ssize_t readSize <span style="color:#000;font-weight:bold">=</span> lpRecorder<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>read(recordBuff <span style="color:#000;font-weight:bold">+</span> offsetInBytes,
                                        sizeInBytes <span style="color:#000;font-weight:bold">&gt;</span> (jint)recorderBuffSize <span style="color:#000;font-weight:bold">?</span>
                                            (jint)<span style="color:#900;font-weight:bold">recorderBuffSize</span> : sizeInBytes );
    env<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>ReleaseByteArrayElements(javaAudioData, recordBuff, <span style="color:#099">0</span>);

    <span style="color:#000;font-weight:bold">if</span> (readSize <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">0</span>) {
        readSize <span style="color:#000;font-weight:bold">=</span> (jint)AUDIO_JAVA_INVALID_OPERATION;
    }
    <span style="color:#000;font-weight:bold">return</span> (jint) readSize;
}
</code></pre></td></tr></table>
</div>
</div><h4 id="2arread">2.AR.read</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ssize_t AudioRecord<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>read<span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> buffer<span style="color:#000;font-weight:bold">,</span> size_t userSize<span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>mTransfer <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> TRANSFER_SYNC<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> INVALID_OPERATION<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ssize_t<span style="color:#000;font-weight:bold">(</span>userSize<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> 0 <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">(</span>buffer <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> NULL <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> userSize <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#998;font-style:italic">//检查。用户最有可能传递错误代码，这将使返回值不明确(实际上是size vs error)。
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// sanity-check. user is most-likely passing an error code, and it would
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// make the return value ambiguous (actualSize vs error).
</span><span style="color:#998;font-style:italic"></span>        ALOGE<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;AudioRecord::read(buffer=%p, size=%zu (%zu)&#34;</span><span style="color:#000;font-weight:bold">,</span> buffer<span style="color:#000;font-weight:bold">,</span> userSize<span style="color:#000;font-weight:bold">,</span> userSize<span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">return</span> BAD_VALUE<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    ssize_t read <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
    Buffer audioBuffer<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>userSize <span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">=</span> mFrameSize<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        audioBuffer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">frameCount</span> <span style="color:#000;font-weight:bold">=</span> userSize <span style="color:#000;font-weight:bold">/</span> mFrameSize<span style="color:#000;font-weight:bold">;</span>

        status_t err <span style="color:#000;font-weight:bold">=</span> obtainBuffer<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">&amp;</span>audioBuffer<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">&amp;</span>ClientProxy<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>kForever<span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>err <span style="color:#000;font-weight:bold">&lt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>read <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">return</span> ssize_t<span style="color:#000;font-weight:bold">(</span>err<span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        size_t bytesRead <span style="color:#000;font-weight:bold">=</span> audioBuffer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">;</span>
        memcpy<span style="color:#000;font-weight:bold">(</span>buffer<span style="color:#000;font-weight:bold">,</span> audioBuffer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">i8</span><span style="color:#000;font-weight:bold">,</span> bytesRead<span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
        buffer <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> buffer<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> bytesRead<span style="color:#000;font-weight:bold">;</span>
        userSize <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">=</span> bytesRead<span style="color:#000;font-weight:bold">;</span>
        read <span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">=</span> bytesRead<span style="color:#000;font-weight:bold">;</span>

        releaseBuffer<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">&amp;</span>audioBuffer<span style="color:#000;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">return</span> read<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="六stop">六.stop</h3>
<p>stop → native_stop → android_media_AudioRecord_stop → lpRecorder-&gt;stop() :</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#458;font-weight:bold">void</span> AudioRecord<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>stop()
{
    AutoMutex <span style="color:#900;font-weight:bold">lock</span>(mLock);
    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>mActive) {
        <span style="color:#000;font-weight:bold">return</span>;
    }

    mActive <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">false</span>;
    mProxy<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>interrupt();
    mAudioRecord<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>stop();
    <span style="color:#998;font-style:italic">// the record head position will reset to 0, so if a marker is set, we need
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// to activate it again
</span><span style="color:#998;font-style:italic"></span>    mMarkerReached <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">false</span>;
    sp<span style="color:#000;font-weight:bold">&lt;</span>AudioRecordThread<span style="color:#000;font-weight:bold">&gt;</span> t <span style="color:#000;font-weight:bold">=</span> mAudioRecordThread;
    <span style="color:#000;font-weight:bold">if</span> (t <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
        t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>pause();
    } <span style="color:#000;font-weight:bold">else</span> {
        setpriority(PRIO_PROCESS, <span style="color:#099">0</span>, mPreviousPriority);
        set_sched_policy(<span style="color:#099">0</span>, mPreviousSchedulingGroup);
    }
}

</code></pre></td></tr></table>
</div>
</div><p>停止的过程较为简单，应用程序侧跨进程调用AudioFlinger侧的stop，从而调用AudioSystem::stopInput，再到AudioPolicyService::stopInput，再到音频策略管理器（如AudioPolicyManagerBase）的stopInput，接着再使用AudioFlinger再到HAL音频硬件的setParameters将AudioParameter::keyRouting设置为0。在停止完输入设备后，应用程序侧需要停止其回调函数线程。</p>
<p>关于录音数据的采集，以及停止。由于时间原因，我就没有仔细的跟下去。有兴趣的可以自己跟一下。</p>
<h3 id="七参考资料">七.参考资料</h3>
<p><a href="https://blog.csdn.net/brightming/article/details/50267589">Android源码分析：录音AudioRecording</a>
<a href="https://blog.csdn.net/qq_29028177/article/details/72726067">AudioRecord 流程及源码分析</a></p>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="http://blog.bingtan.online">冰炭不投day</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="http://blog.bingtan.online/posts/Android/Android%E5%BD%95%E9%9F%B3%E4%B8%8BAudioRecord%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">http://blog.bingtan.online/posts/Android/Android%E5%BD%95%E9%9F%B3%E4%B8%8BAudioRecord%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/posts/Android/Android%E5%BD%95%E9%9F%B3%E4%B8%8AAudioRecord%E5%AE%9E%E7%8E%B0%E5%BD%95%E9%9F%B3%E5%8A%9F%E8%83%BD/">Android录音上————AudioRecord实现录音功能</a></li>
        
        <li><a href="/posts/Android/Android-MVP%E5%BA%94%E7%94%A8/">Android MVP应用程序</a></li>
        
        <li><a href="/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%8426%E6%9C%89%E5%BA%8F%E8%A1%A8%E6%9F%A5%E6%89%BE/">数据结构26————有序表查找</a></li>
        
        <li><a href="/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%8425-%E9%A1%BA%E5%BA%8F%E8%A1%A8%E6%9F%A5%E6%89%BE/">数据结构25————图的拓扑排序和关键排序</a></li>
        
        <li><a href="/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%8424%E5%9B%BE%E7%9A%84%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F%E5%92%8C%E5%85%B3%E9%94%AE%E6%8E%92%E5%BA%8F/">数据结构24————图的拓扑排序和关键排序</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='http://blog.bingtan.online/tags/Android'>Android</a></li>
                
                <li><a href='http://blog.bingtan.online/tags/%E5%BD%95%E9%9F%B3'>录音</a></li>
                
            </ul>
            
        </div>
    </article>
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yourdiscussshortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "https://github.com/hsc396612325/HSCBlog/tree/gh-pages"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='http://blog.bingtan.online/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://blog.bingtan.online">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    
    <section class="widget">
        <h3 class="widget-title">文章目录</h3>
<ul class="widget-list">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一概述">一.概述</a>
      <ul>
        <li><a href="#1主要分析点">1.主要分析点</a></li>
        <li><a href="#2储备知识">2.储备知识</a></li>
      </ul>
    </li>
    <li><a href="#二getminbuffersize">二.getMinBufferSize</a>
      <ul>
        <li><a href="#1argetminbuffersizejava">1.AR.getMinBufferSize(java)</a></li>
        <li><a href="#2argetminbuffersizec">2.AR.getMinBufferSize(c++)</a></li>
      </ul>
    </li>
    <li><a href="#三new-audiorecord">三.new AudioRecord</a>
      <ul>
        <li><a href="#1arnew-audiorecordjava">1.AR.new AudioRecord(java)</a></li>
        <li><a href="#2arandroid_media_audiorecord_setupc">2.AR.android_media_AudioRecord_setup(c++)</a></li>
        <li><a href="#3arsetc">3.AR.set(c++)</a></li>
        <li><a href="#4asget_audio_flingerc">4.AS.get_audio_flinger(c++)</a></li>
        <li><a href="#5iafopenrecordc">5.IAF.openRecord(c++)</a></li>
        <li><a href="#6afopenrecordc">6.AF.openRecord(c++)</a></li>
        <li><a href="#7流程梳理">7.流程梳理</a></li>
      </ul>
    </li>
    <li><a href="#四-startrecording">四. startRecording</a>
      <ul>
        <li><a href="#1arstartrecordingjava">1.AR.startRecording(java)</a></li>
        <li><a href="#2arstartrecordingc">2.AR.startRecording(c++)</a></li>
        <li><a href="#3arstartc">3.AR.start(c++)</a></li>
        <li><a href="#4rtstartc">4.RT.start(c++)</a></li>
        <li><a href="#5asstartinputc">5.AS.startInput(c++)</a></li>
        <li><a href="#6apsstartinputc">6.APS.startInput(c++)</a></li>
        <li><a href="#7apmbstartinputc">7.APMB.startInput(c++)</a></li>
        <li><a href="#8-apssetparametersc">8. APS.setParameters(c++)</a></li>
        <li><a href="#9assetparametersc">9.AS.setParameters(c++)</a></li>
        <li><a href="#10afsetparametersc">10.AF.setParameters(c++)</a></li>
        <li><a href="#11流程梳理">11.流程梳理</a></li>
      </ul>
    </li>
    <li><a href="#五read">五.read</a>
      <ul>
        <li><a href="#1android_media_audiorecord_readinbytearray">1.android_media_AudioRecord_readInByteArray</a></li>
        <li><a href="#2arread">2.AR.read</a></li>
      </ul>
    </li>
    <li><a href="#六stop">六.stop</a></li>
    <li><a href="#七参考资料">七.参考资料</a></li>
  </ul>
</nav>
</ul>
    </section>
    

    

    

    
   
    

    

    
    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://blog.bingtan.online/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="http://blog.bingtan.online">冰炭不投day的博客 By 冰炭不投day</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

</body>

</html>