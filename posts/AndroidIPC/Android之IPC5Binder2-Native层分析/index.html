<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title> | 冰炭不投day的博客</title>
    <meta property="og:title" content=" - 冰炭不投day的博客">
    <meta property="og:type" content="article">
        
        
    <meta name="Keywords" content="Android 冰炭不投day">
    <meta name="description" content="">
        
    <meta name="author" content="冰炭不投day">
    <meta property="og:url" content="http://blog.bingtan.online/posts/AndroidIPC/Android%E4%B9%8BIPC5Binder2-Native%E5%B1%82%E5%88%86%E6%9E%90/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-4031353640611810",
        enable_page_level_ads: true
    });
    </script>
    


    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://blog.bingtan.online">
                        冰炭不投day的博客
                    </a>
                
                <p class="description">若向往 我敢往</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="http://blog.bingtan.online">首页</a>
                    
                    <a  href="http://blog.bingtan.online/tools/" title="工具">工具</a>
                    
                    <a  href="http://blog.bingtan.online/archives/" title="归档">归档</a>
                    
                    <a  href="http://blog.bingtan.online/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title"></h1>
        </header>
        <date class="post-meta meta-date">
            1年1月1日
        </date>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        

        
        
        <div class="post-content">
            <h1 id="android之ipc5binder2-native层分析">Android之IPC5————Binder2 Native层分析</h1>
<p>@[toc]</p>
<h3 id="一前言">一.前言</h3>
<p>在上一篇里，我们介绍了binder机制的简单介绍，以及binder内核，ServiceManager的启动。
在上一篇也简单提过，ServiceManager的作用，即注册服务，和获取服务。
<img src="https://imgconvert.csdnimg.cn/aHR0cDovL2dpdHl1YW4uY29tL2ltYWdlcy9iaW5kZXIvamF2YV9iaW5kZXIvamF2YV9iaW5kZXIuanBn?x-oss-process=image/format,png" alt="在这里插入图片描述">
在这一篇中，我们中 主要分析native层，主要分析其注册服务和获取服务的过程，大致流程就是获取BpServiceManager，通过它来和Binder驱动进行通信，ServiceManager在死循环中读写事物，对注册服务和获取服务进行处理，并将结果返回给Binder驱动，binder驱动在将结果返回给客户端或服务端。</p>
<p>本篇文章主要以下面几个方面展开：</p>
<ul>
<li>获取BpServiceManager</li>
<li>Native层的注册服务和获取服务</li>
<li>Binder内核中的注册服务和获取服务</li>
<li>ServiceManager中的注册服务和获取服务的</li>
</ul>
<h3 id="二获取bpservicemanager">二.获取BpServiceManager</h3>
<h4 id="1概述">1.概述</h4>
<blockquote>
<p>BpServiceManagerton通过接口IServiceManager实现了接口中的业务逻辑函数(获取服务，注册服务)，并通过成员变量mRemote= new BpBinder(0)进行Binder通信工作</p>
</blockquote>
<p>获取BpServiceManager是通过defaultServiceManager()方法来完成，当进程注册服务(addService)或 获取服务(getService)的过程之前，都需要先调用defaultServiceManager()方法来获取gDefaultServiceManager对象。对于gDefaultServiceManager对象，如果存在则直接返回；如果不存在则创建该对象</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#000;font-weight:bold">&lt;</span>IServiceManager<span style="color:#000;font-weight:bold">&gt;</span> defaultServiceManager()
{
    <span style="color:#000;font-weight:bold">if</span> (gDefaultServiceManager <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) <span style="color:#000;font-weight:bold">return</span> gDefaultServiceManager;
    {
        AutoMutex <span style="color:#900;font-weight:bold">_l</span>(gDefaultServiceManagerLock); <span style="color:#998;font-style:italic">//加锁
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">while</span> (gDefaultServiceManager <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
         
            gDefaultServiceManager <span style="color:#000;font-weight:bold">=</span> interface_cast<span style="color:#000;font-weight:bold">&lt;</span>IServiceManager<span style="color:#000;font-weight:bold">&gt;</span>(
                ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getContextObject(<span style="color:#0086b3">NULL</span>));
            <span style="color:#000;font-weight:bold">if</span> (gDefaultServiceManager <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>)
                sleep(<span style="color:#099">1</span>);
        }
    }
    <span style="color:#000;font-weight:bold">return</span> gDefaultServiceManager;
}
</code></pre></td></tr></table>
</div>
</div><p>上面就是获取BpServiceManager的过程</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">gDefaultServiceManager <span style="color:#000;font-weight:bold">=</span> interface_cast<span style="color:#000;font-weight:bold">&lt;</span>IServiceManager<span style="color:#000;font-weight:bold">&gt;</span>(
                ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getContextObject(<span style="color:#0086b3">NULL</span>));
</code></pre></td></tr></table>
</div>
</div><p>上面这行代码就是关键代码，分为3步,即</p>
<ul>
<li>ProcessState::self()，获取ProcessState对象，也是单例</li>
<li>getContextObject：获取BpBinder，对于handle = 0的BpBinder对象，存在直接返回，否则创建</li>
<li>获取BpServiceManager对象</li>
</ul>
<h4 id="2获取processstate对象">2.获取ProcessState对象</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#000;font-weight:bold">&lt;</span>ProcessState<span style="color:#000;font-weight:bold">&gt;</span> ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()
{
    Mutex<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>Autolock _l(gProcessMutex);
    <span style="color:#000;font-weight:bold">if</span> (gProcess <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
        <span style="color:#000;font-weight:bold">return</span> gProcess;
    }

    <span style="color:#998;font-style:italic">//实例化ProcessState 【见小节2.2】
</span><span style="color:#998;font-style:italic"></span>    gProcess <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ProcessState;
    <span style="color:#000;font-weight:bold">return</span> gProcess;
}
</code></pre></td></tr></table>
</div>
</div><p>获取ProcessState对象,也是单例模式.</p>
<p>ProcessState的初始化</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>ProcessState()
    <span style="color:#000;font-weight:bold">:</span> mDriverFD(open_driver()) <span style="color:#998;font-style:italic">// 打开Binder驱动【见小节2.3】
</span><span style="color:#998;font-style:italic"></span>    , mVMStart(MAP_FAILED)
    , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER)
    , mThreadCountDecrement(PTHREAD_COND_INITIALIZER)
    , mExecutingThreadsCount(<span style="color:#099">0</span>)
    , mMaxThreads(DEFAULT_MAX_BINDER_THREADS)
    , mManagesContexts(<span style="color:#0086b3">false</span>)
    , mBinderContextCheckFunc(<span style="color:#0086b3">NULL</span>)
    , mBinderContextUserData(<span style="color:#0086b3">NULL</span>)
    , mThreadPoolStarted(<span style="color:#0086b3">false</span>)
    , mThreadPoolSeq(<span style="color:#099">1</span>)
{
    <span style="color:#000;font-weight:bold">if</span> (mDriverFD <span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
        <span style="color:#998;font-style:italic">//采用内存映射函数mmap，给binder分配一块虚拟地址空间,用来接收事务
</span><span style="color:#998;font-style:italic"></span>        mVMStart <span style="color:#000;font-weight:bold">=</span> mmap(<span style="color:#099">0</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE <span style="color:#000;font-weight:bold">|</span> MAP_NORESERVE, mDriverFD, <span style="color:#099">0</span>);
        <span style="color:#000;font-weight:bold">if</span> (mVMStart <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> MAP_FAILED) {
            close(mDriverFD); <span style="color:#998;font-style:italic">//没有足够空间分配给/dev/binder,则关闭驱动
</span><span style="color:#998;font-style:italic"></span>            mDriverFD <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
        }
    }

</code></pre></td></tr></table>
</div>
</div><p>在初始化时打开Binder设备，并设定binder支持的最大线程数，之后再使用mmap分配内存。</p>
<h4 id="3获取bpbinder对象">3.获取BpBinder对象</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span> ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>getContextObject(<span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#998;font-style:italic">/*caller*/</span>)
{
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">getStrongProxyForHandle</span>(<span style="color:#099">0</span>);  
}
</code></pre></td></tr></table>
</div>
</div><p>获取handle = 0的IBinder。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span> ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>getStrongProxyForHandle(<span style="color:#458;font-weight:bold">int32_t</span> handle)
{
    sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span> result;

    AutoMutex <span style="color:#900;font-weight:bold">_l</span>(mLock);
    <span style="color:#998;font-style:italic">//查找handle对应的资源项
</span><span style="color:#998;font-style:italic"></span>    handle_entry<span style="color:#000;font-weight:bold">*</span> e <span style="color:#000;font-weight:bold">=</span> lookupHandleLocked(handle);

    <span style="color:#000;font-weight:bold">if</span> (e <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
        IBinder<span style="color:#000;font-weight:bold">*</span> b <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>binder;
        <span style="color:#000;font-weight:bold">if</span> (b <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span> <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">!</span>e<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>refs<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>attemptIncWeak(<span style="color:#000;font-weight:bold">this</span>)) {
            <span style="color:#000;font-weight:bold">if</span> (handle <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
                Parcel data;
                <span style="color:#998;font-style:italic">//通过ping操作测试binder是否准备就绪
</span><span style="color:#998;font-style:italic"></span>                status_t status <span style="color:#000;font-weight:bold">=</span> IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>transact(
                        <span style="color:#099">0</span>, IBinder<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>PING_TRANSACTION, data, <span style="color:#0086b3">NULL</span>, <span style="color:#099">0</span>);
                <span style="color:#000;font-weight:bold">if</span> (status <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> DEAD_OBJECT)
                   <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;
            }
            <span style="color:#998;font-style:italic">//当handle值所对应的IBinder不存在或弱引用无效时，则创建BpBinder对象
</span><span style="color:#998;font-style:italic"></span>            b <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BpBinder(handle);
            e<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>binder <span style="color:#000;font-weight:bold">=</span> b;
            <span style="color:#000;font-weight:bold">if</span> (b) e<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>refs <span style="color:#000;font-weight:bold">=</span> b<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getWeakRefs();
            result <span style="color:#000;font-weight:bold">=</span> b;
        } <span style="color:#000;font-weight:bold">else</span> {
            result.force_set(b);
            e<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>refs<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>decWeak(<span style="color:#000;font-weight:bold">this</span>);
        }
    }
    <span style="color:#000;font-weight:bold">return</span> result;
}
</code></pre></td></tr></table>
</div>
</div><h4 id="4获取bpservicemanager">4.获取BpServiceManager</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">template</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">typename</span> INTERFACE<span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">inline</span> sp<span style="color:#000;font-weight:bold">&lt;</span>INTERFACE<span style="color:#000;font-weight:bold">&gt;</span> interface_cast(<span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> obj)
{
    <span style="color:#000;font-weight:bold">return</span> INTERFACE<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>asInterface(obj); 
}
</code></pre></td></tr></table>
</div>
</div><p>在源码中INTERFACE::asInterface(obj)使用宏的模的模拟代码。直接写出替换后的代码</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000;font-weight:bold">const</span> android<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>String16 IServiceManager<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>descriptor(<span style="color:#a61717;background-color:#e3d2d2">“</span>android.os.IServiceManager<span style="color:#a61717;background-color:#e3d2d2">”</span>);

<span style="color:#000;font-weight:bold">const</span> android<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>String16<span style="color:#000;font-weight:bold">&amp;</span> IServiceManager<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>getInterfaceDescriptor() <span style="color:#000;font-weight:bold">const</span>
{
     <span style="color:#000;font-weight:bold">return</span> IServiceManager<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>descriptor;
}

 android<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>sp<span style="color:#000;font-weight:bold">&lt;</span>IServiceManager<span style="color:#000;font-weight:bold">&gt;</span> IServiceManager<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>asInterface(<span style="color:#000;font-weight:bold">const</span> android<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>sp<span style="color:#000;font-weight:bold">&lt;</span>android<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> obj)
{
       android<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>sp<span style="color:#000;font-weight:bold">&lt;</span>IServiceManager<span style="color:#000;font-weight:bold">&gt;</span> intr;
        <span style="color:#000;font-weight:bold">if</span>(obj <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
           intr <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">static_cast</span><span style="color:#000;font-weight:bold">&lt;</span>IServiceManager <span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">&gt;</span>(
               obj<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>queryLocalInterface(IServiceManager<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>descriptor).get());
           <span style="color:#000;font-weight:bold">if</span> (intr <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
               intr <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BpServiceManager(obj);  
            }
        }
       <span style="color:#000;font-weight:bold">return</span> intr;
}

IServiceManager<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>IServiceManager () { }
IServiceManager<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">~</span> IServiceManager() { }
</code></pre></td></tr></table>
</div>
</div><p>所有说IServiceManager::asInterface() 等价于 new BpServiceManager()。</p>
<p>接下来看BpServiceManager的初始化</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">BpServiceManager(<span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> impl)
    <span style="color:#000;font-weight:bold">:</span> BpInterface<span style="color:#000;font-weight:bold">&lt;</span>IServiceManager<span style="color:#000;font-weight:bold">&gt;</span>(impl)
{    }
</code></pre></td></tr></table>
</div>
</div><p>BpInterface的初始化</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">inline</span> BpInterface<span style="color:#000;font-weight:bold">&lt;</span>INTERFACE<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>BpInterface(<span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> remote)
    <span style="color:#000;font-weight:bold">:</span>BpRefBase(remote)
{    }
</code></pre></td></tr></table>
</div>
</div><p>BpRefBase的初始化</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">BpRefBase<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>BpRefBase(<span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> o)
    <span style="color:#000;font-weight:bold">:</span> mRemote(o.get()), mRefs(<span style="color:#0086b3">NULL</span>), mState(<span style="color:#099">0</span>)
{
    extendObjectLifetime(OBJECT_LIFETIME_WEAK);

    <span style="color:#000;font-weight:bold">if</span> (mRemote) {
        mRemote<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>incStrong(<span style="color:#000;font-weight:bold">this</span>);
        mRefs <span style="color:#000;font-weight:bold">=</span> mRemote<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>createWeak(<span style="color:#000;font-weight:bold">this</span>);
    }
}
</code></pre></td></tr></table>
</div>
</div><p>new BpServiceManager()，在初始化过程中，比较重要工作的是类BpRefBase的mRemote指向new BpBinder(0)，从而BpServiceManager能够利用Binder进行通过通信。</p>
<h4 id="5总结">5.总结</h4>
<p>defaultServiceManager 等价于 new BpServiceManager(new BpBinder(0));</p>
<p>在这个过程中:</p>
<ul>
<li>调用open()，打开/dev/binder驱动设备；</li>
<li>再利用mmap()，创建大小为1M-8K的内存地址空间；</li>
<li>设定当前进程最大的最大并发Binder线程个数为16</li>
<li>BpBinder通过handler来指向所对应BBinder, 在整个Binder系统中handle=0代表ServiceManager所对应的BBinder。</li>
</ul>
<h3 id="三native层的注册服务和获取服务">三.Native层的注册服务和获取服务</h3>
<h4 id="1服务注册">1.服务注册</h4>
<p>我们以media服务注册为例</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">main</span>(<span style="color:#458;font-weight:bold">int</span> argc __unused, <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">*</span> argv)
{
    ...
    InitializeIcuOrDie();
    <span style="color:#998;font-style:italic">//获得ProcessState实例对象
</span><span style="color:#998;font-style:italic"></span>    sp<span style="color:#000;font-weight:bold">&lt;</span>ProcessState<span style="color:#000;font-weight:bold">&gt;</span> proc(ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self());
    <span style="color:#998;font-style:italic">//获取BpServiceManager对象
</span><span style="color:#998;font-style:italic"></span>    sp<span style="color:#000;font-weight:bold">&lt;</span>IServiceManager<span style="color:#000;font-weight:bold">&gt;</span> sm <span style="color:#000;font-weight:bold">=</span> defaultServiceManager();
    AudioFlinger<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>instantiate();
    <span style="color:#998;font-style:italic">//注册多媒体服务  
</span><span style="color:#998;font-style:italic"></span>    MediaPlayerService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>instantiate();
    ResourceManagerService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>instantiate();
    CameraService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>instantiate();
    AudioPolicyService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>instantiate();
    SoundTriggerHwService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>instantiate();
    RadioService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>instantiate();
    registerExtensions();
    <span style="color:#998;font-style:italic">//启动Binder线程池
</span><span style="color:#998;font-style:italic"></span>    ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>startThreadPool();
    <span style="color:#998;font-style:italic">//当前线程加入到线程池
</span><span style="color:#998;font-style:italic"></span>    IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>joinThreadPool();
 }
</code></pre></td></tr></table>
</div>
</div><p>上面是native层中media服务注册的过程。
分为下面几个过程：</p>
<ul>
<li>获取ProcessState对象</li>
<li>获取ServiceManager对象</li>
<li>注册服务</li>
<li>启动binder线程池</li>
<li>加入到线程池</li>
</ul>
<p>在这其中，获取ProcessState对象和获取ServiceManager对象的过程，在上一小节。</p>
<p>我们主要来看其注册服务的过程。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#458;font-weight:bold">void</span> MediaPlayerService<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>instantiate() {
    <span style="color:#998;font-style:italic">//注册服务
</span><span style="color:#998;font-style:italic"></span>    defaultServiceManager()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>addService(String16(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">media.player</span><span style="color:#d14">&#34;</span>), <span style="color:#000;font-weight:bold">new</span> MediaPlayerService());
}
</code></pre></td></tr></table>
</div>
</div><p>由上一小节可知 defaultServiceManager()返回的是BpServiceManager，所以相当于bpServiceManager调用addService。</p>
<p>BpSM.addService</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">virtual</span> status_t <span style="color:#900;font-weight:bold">addService</span>(<span style="color:#000;font-weight:bold">const</span> String16<span style="color:#000;font-weight:bold">&amp;</span> name, <span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> service, <span style="color:#458;font-weight:bold">bool</span> allowIsolated) {
    Parcel data, reply; <span style="color:#998;font-style:italic">//Parcel是数据通信包
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//写入头信息&#34;android.os.IServiceManager&#34;
</span><span style="color:#998;font-style:italic"></span>    data.writeInterfaceToken(IServiceManager<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>getInterfaceDescriptor());   
    data.writeString16(name);        
    <span style="color:#998;font-style:italic">// name为 &#34;media.player&#34;
</span><span style="color:#998;font-style:italic"></span>    data.writeStrongBinder(service); 
    <span style="color:#998;font-style:italic">// MediaPlayerService对象
</span><span style="color:#998;font-style:italic"></span>    data.writeInt32(allowIsolated <span style="color:#000;font-weight:bold">?</span> <span style="color:#099">1</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#099">0</span>);
    <span style="color:#998;font-style:italic">// allowIsolated= false
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//remote()指向的是BpBinder对象
</span><span style="color:#998;font-style:italic"></span>    status_t err <span style="color:#000;font-weight:bold">=</span> remote()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>transact(ADD_SERVICE_TRANSACTION, data, <span style="color:#000;font-weight:bold">&amp;</span>reply);
    <span style="color:#000;font-weight:bold">return</span> err <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR <span style="color:#000;font-weight:bold">?</span> reply.readExceptionCode() <span style="color:#000;font-weight:bold">:</span> err;
}
</code></pre></td></tr></table>
</div>
</div><p>可以看到，在addService中将Service对象和Service名都写入了data中。</p>
<p>之后调用BpBinder对象的transact方法。</p>
<h4 id="2获取服务">2.获取服务</h4>
<p>上面是media在native层注册服务的过程，下面介绍一下madia服务被获取的过程</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#000;font-weight:bold">&lt;</span>IMediaPlayerService<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span>
IMediaDeathNotifier<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>getMediaPlayerService()
{
    Mutex<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>Autolock _l(sServiceLock);
    <span style="color:#000;font-weight:bold">if</span> (sMediaPlayerService <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
        sp<span style="color:#000;font-weight:bold">&lt;</span>IServiceManager<span style="color:#000;font-weight:bold">&gt;</span> sm <span style="color:#000;font-weight:bold">=</span> defaultServiceManager(); <span style="color:#998;font-style:italic">//获取ServiceManager
</span><span style="color:#998;font-style:italic"></span>        sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span> binder;
        <span style="color:#000;font-weight:bold">do</span> {
            <span style="color:#998;font-style:italic">//获取名为&#34;media.player&#34;的服务
</span><span style="color:#998;font-style:italic"></span>            binder <span style="color:#000;font-weight:bold">=</span> sm<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getService(String16(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">media.player</span><span style="color:#d14">&#34;</span>));
            <span style="color:#000;font-weight:bold">if</span> (binder <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
                <span style="color:#000;font-weight:bold">break</span>;
            }
            usleep(<span style="color:#099">500000</span>); <span style="color:#998;font-style:italic">// 0.5s
</span><span style="color:#998;font-style:italic"></span>        } <span style="color:#000;font-weight:bold">while</span> (<span style="color:#0086b3">true</span>);

        <span style="color:#000;font-weight:bold">if</span> (sDeathNotifier <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
            sDeathNotifier <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DeathNotifier(); <span style="color:#998;font-style:italic">//创建死亡通知对象
</span><span style="color:#998;font-style:italic"></span>        }

        <span style="color:#998;font-style:italic">//将死亡通知连接到binder 
</span><span style="color:#998;font-style:italic"></span>        binder<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>linkToDeath(sDeathNotifier);
        sMediaPlayerService <span style="color:#000;font-weight:bold">=</span> interface_cast<span style="color:#000;font-weight:bold">&lt;</span>IMediaPlayerService<span style="color:#000;font-weight:bold">&gt;</span>(binder);
    }
    <span style="color:#000;font-weight:bold">return</span> sMediaPlayerService;
}
</code></pre></td></tr></table>
</div>
</div><p>上面的代码就是请求获取为”media.player”的服务过程中，采用不断获取的过程。</p>
<p>也是先获BpServiceManager，然后调用BpServiceManager的getService方法。</p>
<p>来看其获取服务的代码</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">virtual</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span> getService(<span style="color:#000;font-weight:bold">const</span> String16<span style="color:#000;font-weight:bold">&amp;</span> name) <span style="color:#000;font-weight:bold">const</span>
    {
        <span style="color:#458;font-weight:bold">unsigned</span> n;
        <span style="color:#000;font-weight:bold">for</span> (n <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; n <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">5</span>; n<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>){
            sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span> svc <span style="color:#000;font-weight:bold">=</span> checkService(name); <span style="color:#998;font-style:italic">//见下
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> (svc <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) <span style="color:#000;font-weight:bold">return</span> svc;
            sleep(<span style="color:#099">1</span>);
        }
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;
    }
</code></pre></td></tr></table>
</div>
</div><p>通过ServiceManager来获取服务，检索服务是否存在，存在直接返回，不存在时。暂停1s后，继续请求。最多5次</p>
<p>继续来看checkService(name)过程</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#000;font-weight:bold">virtual</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span> checkService( <span style="color:#000;font-weight:bold">const</span> String16<span style="color:#000;font-weight:bold">&amp;</span> name) <span style="color:#000;font-weight:bold">const</span>
{
    Parcel data, reply;
    <span style="color:#998;font-style:italic">//写入RPC头
</span><span style="color:#998;font-style:italic"></span>    data.writeInterfaceToken(IServiceManager<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>getInterfaceDescriptor());
    <span style="color:#998;font-style:italic">//写入服务名
</span><span style="color:#998;font-style:italic"></span>    data.writeString16(name);
    remote()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>transact(CHECK_SERVICE_TRANSACTION, data, <span style="color:#000;font-weight:bold">&amp;</span>reply); <span style="color:#998;font-style:italic">//见下
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> reply.readStrongBinder(); <span style="color:#998;font-style:italic">//见下
</span><span style="color:#998;font-style:italic"></span>}
</code></pre></td></tr></table>
</div>
</div><p>可以看出了获取服务和注册服务一样，最终都调用了Bpdineder的transact。</p>
<h4 id="3注册服务中writestrongbinderservice">3.注册服务中writeStrongBinder(service)</h4>
<p>在注册服务中，将Service传入writeStrongBinder中</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">  data.writeStrongBinder(service);
</code></pre></td></tr></table>
</div>
</div><p>data是Parcel类。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">status_t Parcel<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>writeStrongBinder(<span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> val)
{
    <span style="color:#000;font-weight:bold">return</span> flatten_binder(ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self(), val, this);
}
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">status_t <span style="color:#900;font-weight:bold">flatten_binder</span>(<span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>ProcessState<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#998;font-style:italic">/*proc*/</span>,
    <span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> binder, Parcel<span style="color:#000;font-weight:bold">*</span> out)
{
    flat_binder_object obj;

    obj.flags <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0x7f</span> <span style="color:#000;font-weight:bold">|</span> FLAT_BINDER_FLAG_ACCEPTS_FDS;
    <span style="color:#000;font-weight:bold">if</span> (binder <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
        IBinder <span style="color:#000;font-weight:bold">*</span>local <span style="color:#000;font-weight:bold">=</span> binder<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>localBinder(); <span style="color:#998;font-style:italic">//本地Binder不为空
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>local) {
            BpBinder <span style="color:#000;font-weight:bold">*</span>proxy <span style="color:#000;font-weight:bold">=</span> binder<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>remoteBinder();
            <span style="color:#000;font-weight:bold">const</span> int32_t handle <span style="color:#000;font-weight:bold">=</span> proxy <span style="color:#000;font-weight:bold">?</span> proxy<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle() <span style="color:#000;font-weight:bold">:</span> <span style="color:#099">0</span>;
            obj.type <span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_HANDLE;
            obj.binder <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
            obj.handle <span style="color:#000;font-weight:bold">=</span> handle;
            obj.cookie <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
        } <span style="color:#000;font-weight:bold">else</span> { <span style="color:#998;font-style:italic">//进入该分支
</span><span style="color:#998;font-style:italic"></span>            obj.type <span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_BINDER;
            obj.binder <span style="color:#000;font-weight:bold">=</span> reinterpret_cast<span style="color:#000;font-weight:bold">&lt;</span>uintptr_t<span style="color:#000;font-weight:bold">&gt;</span>(local<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getWeakRefs());
            obj.cookie <span style="color:#000;font-weight:bold">=</span> reinterpret_cast<span style="color:#000;font-weight:bold">&lt;</span>uintptr_t<span style="color:#000;font-weight:bold">&gt;</span>(local);
        }
    } <span style="color:#000;font-weight:bold">else</span> {
        ...
    }
   
    <span style="color:#000;font-weight:bold">return</span> finish_flatten_binder(binder, obj, out);
}
</code></pre></td></tr></table>
</div>
</div><p>将Binder对象扁平化，转换成flat_binder_object对象。</p>
<ul>
<li>对于Binder实体，则cookie记录Binder实体的指针；并且其类型为BINDER_TYPE_HANDLE</li>
<li>对于Binder代理，则用handle记录Binder代理的句柄，并且其类型为BINDER_TYPE_BINDER；</li>
</ul>
<h4 id="4获取服务的readstrongbinder">4.获取服务的readStrongBinder()</h4>
<p>在获取服务中，最后返回的是：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">return</span> reply.readStrongBinder(); 
</code></pre></td></tr></table>
</div>
</div><p>和data一样，reply也是Parcel类。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span> Parcel<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>readStrongBinder() <span style="color:#000;font-weight:bold">const</span>
{
    sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span> val;
    unflatten_binder(ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self(), <span style="color:#000;font-weight:bold">*</span>this, <span style="color:#000;font-weight:bold">&amp;</span>val);
    <span style="color:#000;font-weight:bold">return</span> val;
}
</code></pre></td></tr></table>
</div>
</div><p>调用了 unflatten_binder</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">status_t <span style="color:#900;font-weight:bold">unflatten_binder</span>(<span style="color:#000;font-weight:bold">const</span> sp<span style="color:#000;font-weight:bold">&lt;</span>ProcessState<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">&amp;</span> proc, <span style="color:#000;font-weight:bold">const</span> Parcel<span style="color:#000;font-weight:bold">&amp;</span> in, sp<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">*</span> out) {
    <span style="color:#000;font-weight:bold">const</span> flat_binder_object<span style="color:#000;font-weight:bold">*</span> flat <span style="color:#000;font-weight:bold">=</span> in.readObject(<span style="color:#0086b3">false</span>);
    <span style="color:#000;font-weight:bold">if</span> (flat) {
        <span style="color:#000;font-weight:bold">switch</span> (flat<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type) {
            <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BINDER_TYPE_BINDER</span>:
               <span style="color:#998;font-style:italic">// 当请求服务的进程与服务属于同一进程
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">*</span>out <span style="color:#000;font-weight:bold">=</span> reinterpret_cast<span style="color:#000;font-weight:bold">&lt;</span>IBinder<span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">&gt;</span>(flat<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>cookie);
                <span style="color:#000;font-weight:bold">return</span> finish_unflatten_binder(<span style="color:#0086b3">NULL</span>, <span style="color:#000;font-weight:bold">*</span>flat, in);
            <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BINDER_TYPE_HANDLE</span>:
                <span style="color:#998;font-style:italic">//请求服务的进程与服务属于不同进程
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">*</span>out <span style="color:#000;font-weight:bold">=</span> proc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>getStrongProxyForHandle(flat<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle);
                <span style="color:#998;font-style:italic">//创建BpBinder对象
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">return</span> finish_unflatten_binder(
                    static_cast<span style="color:#000;font-weight:bold">&lt;</span>BpBinder<span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">&gt;</span>(out<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>get()), <span style="color:#000;font-weight:bold">*</span>flat, in);
        }
    }
    <span style="color:#000;font-weight:bold">return</span> BAD_TYPE;
}
</code></pre></td></tr></table>
</div>
</div><h4 id="5bpbindertransact">5.BpBinder.transact</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t err <span style="color:#000;font-weight:bold">=</span> remote()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>transact(ADD_SERVICE_TRANSACTION, data, <span style="color:#000;font-weight:bold">&amp;</span>reply);
</code></pre></td></tr></table>
</div>
</div><p>在注册服务和获取服务中，最终都调用了上面这行代码。即BpBinder.transact方法。</p>
<p>BpBinder.transact</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t BpBinder<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>transact(
    <span style="color:#458;font-weight:bold">uint32_t</span> code, <span style="color:#000;font-weight:bold">const</span> Parcel<span style="color:#000;font-weight:bold">&amp;</span> data, Parcel<span style="color:#000;font-weight:bold">*</span> reply, <span style="color:#458;font-weight:bold">uint32_t</span> flags)
{
    <span style="color:#000;font-weight:bold">if</span> (mAlive) {
        <span style="color:#998;font-style:italic">// code=ADD_SERVICE_TRANSACTION
</span><span style="color:#998;font-style:italic"></span>        status_t status <span style="color:#000;font-weight:bold">=</span> IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>transact(
            mHandle, code, data, reply, flags);
        <span style="color:#000;font-weight:bold">if</span> (status <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> DEAD_OBJECT) mAlive <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
        <span style="color:#000;font-weight:bold">return</span> status;
    }
    <span style="color:#000;font-weight:bold">return</span> DEAD_OBJECT;
}
</code></pre></td></tr></table>
</div>
</div><p>可以看出在 BpBinder::transact中最终调用的是IPCThreadState::self()-&gt;transact方法。</p>
<p>先来看看IPCThreadState的初始化过程和self过程</p>
<h4 id="6-ipcthreadstate的初始化">6. IPCThreadState的初始化</h4>
<p>初始化：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>IPCThreadState()
    <span style="color:#000;font-weight:bold">:</span> mProcess(ProcessState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()),
      mMyThreadId(gettid()),
      mStrictModePolicy(<span style="color:#099">0</span>),
      mLastTransactionBinderFlags(<span style="color:#099">0</span>)
{
    pthread_setspecific(gTLS, <span style="color:#000;font-weight:bold">this</span>);
    clearCaller();
    mIn.setDataCapacity(<span style="color:#099">256</span>);<span style="color:#998;font-style:italic">//接收来自binder数据
</span><span style="color:#998;font-style:italic"></span>    mOut.setDataCapacity(<span style="color:#099">256</span>);<span style="color:#998;font-style:italic">//发往binder数据
</span><span style="color:#998;font-style:italic"></span>}
</code></pre></td></tr></table>
</div>
</div><p>self方法：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">IPCThreadState<span style="color:#000;font-weight:bold">*</span> IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>self()
{
    <span style="color:#000;font-weight:bold">if</span> (gHaveTLS) {
<span style="color:#900;font-weight:bold">restart</span>:
        <span style="color:#000;font-weight:bold">const</span> pthread_key_t k <span style="color:#000;font-weight:bold">=</span> gTLS;
        IPCThreadState<span style="color:#000;font-weight:bold">*</span> st <span style="color:#000;font-weight:bold">=</span> (IPCThreadState<span style="color:#000;font-weight:bold">*</span>)pthread_getspecific(k);
        <span style="color:#000;font-weight:bold">if</span> (st) <span style="color:#000;font-weight:bold">return</span> st;
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> IPCThreadState;  <span style="color:#998;font-style:italic">//初始IPCThreadState 
</span><span style="color:#998;font-style:italic"></span>    }

    <span style="color:#000;font-weight:bold">if</span> (gShutdown) <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;

    pthread_mutex_lock(<span style="color:#000;font-weight:bold">&amp;</span>gTLSMutex);
    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>gHaveTLS) { <span style="color:#998;font-style:italic">//首次进入gHaveTLS为false
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (pthread_key_create(<span style="color:#000;font-weight:bold">&amp;</span>gTLS, threadDestructor) <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) { <span style="color:#998;font-style:italic">//创建线程的TLS
</span><span style="color:#998;font-style:italic"></span>            pthread_mutex_unlock(<span style="color:#000;font-weight:bold">&amp;</span>gTLSMutex);
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;
        }
        gHaveTLS <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">true</span>;
    }
    pthread_mutex_unlock(<span style="color:#000;font-weight:bold">&amp;</span>gTLSMutex);
    <span style="color:#000;font-weight:bold">goto</span> restart;
}
</code></pre></td></tr></table>
</div>
</div><p>在self中，对IPCThreadState进行了初始化，并创建了线程的TLS(线程本地存储空间)。</p>
<h4 id="7ipctransact方法">7.IPC.transact方法。</h4>
<p>BpBinder::transact中最终调用的是IPCThreadState::self()-&gt;transact方法。
上一小节中，我们查看了IPCThreadState::self()过程，接下来继续查看其transact方法。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>transact(<span style="color:#458;font-weight:bold">int32_t</span> handle,
                                  <span style="color:#458;font-weight:bold">uint32_t</span> code, <span style="color:#000;font-weight:bold">const</span> Parcel<span style="color:#000;font-weight:bold">&amp;</span> data,
                                  Parcel<span style="color:#000;font-weight:bold">*</span> reply, <span style="color:#458;font-weight:bold">uint32_t</span> flags)
{
    status_t err <span style="color:#000;font-weight:bold">=</span> data.errorCheck(); <span style="color:#998;font-style:italic">//数据错误检查
</span><span style="color:#998;font-style:italic"></span>    flags <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">=</span> TF_ACCEPT_FDS;
    ....
    <span style="color:#000;font-weight:bold">if</span> (err <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) { <span style="color:#998;font-style:italic">// 传输数据 
</span><span style="color:#998;font-style:italic"></span>        err <span style="color:#000;font-weight:bold">=</span> writeTransactionData(BC_TRANSACTION, flags, handle, code, data, <span style="color:#0086b3">NULL</span>);
    }
    ...

    <span style="color:#000;font-weight:bold">if</span> ((flags <span style="color:#000;font-weight:bold">&amp;</span> TF_ONE_WAY) <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) {
        <span style="color:#000;font-weight:bold">if</span> (reply) {
            <span style="color:#998;font-style:italic">//等待响应
</span><span style="color:#998;font-style:italic"></span>            err <span style="color:#000;font-weight:bold">=</span> waitForResponse(reply);
        } <span style="color:#000;font-weight:bold">else</span> {
            Parcel fakeReply;
            err <span style="color:#000;font-weight:bold">=</span> waitForResponse(<span style="color:#000;font-weight:bold">&amp;</span>fakeReply);
        }

    } <span style="color:#000;font-weight:bold">else</span> {
        <span style="color:#998;font-style:italic">//oneway，则不需要等待reply的场景
</span><span style="color:#998;font-style:italic"></span>        err <span style="color:#000;font-weight:bold">=</span> waitForResponse(<span style="color:#0086b3">NULL</span>, <span style="color:#0086b3">NULL</span>);
    }
    <span style="color:#000;font-weight:bold">return</span> err;
}
</code></pre></td></tr></table>
</div>
</div><p>在上面的代码中主要有三个过程，即数据错误检查,传输数据和等待响应。下两个小节来看数据传输过程和等待响应过程。</p>
<h4 id="8ipcwritetransactiondata">8.IPC.writeTransactionData</h4>
<p>writeTransactionData即传输数据过程</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>writeTransactionData(<span style="color:#458;font-weight:bold">int32_t</span> cmd, <span style="color:#458;font-weight:bold">uint32_t</span> binderFlags,
    <span style="color:#458;font-weight:bold">int32_t</span> handle, <span style="color:#458;font-weight:bold">uint32_t</span> code, <span style="color:#000;font-weight:bold">const</span> Parcel<span style="color:#000;font-weight:bold">&amp;</span> data, status_t<span style="color:#000;font-weight:bold">*</span> statusBuffer)
{
    binder_transaction_data tr;
    tr.target.ptr <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    tr.target.handle <span style="color:#000;font-weight:bold">=</span> handle; <span style="color:#998;font-style:italic">// handle = 0
</span><span style="color:#998;font-style:italic"></span>    tr.code <span style="color:#000;font-weight:bold">=</span> code;            <span style="color:#998;font-style:italic">// code = ADD_SERVICE_TRANSACTION
</span><span style="color:#998;font-style:italic"></span>    tr.flags <span style="color:#000;font-weight:bold">=</span> binderFlags;    <span style="color:#998;font-style:italic">// binderFlags = 0
</span><span style="color:#998;font-style:italic"></span>    tr.cookie <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    tr.sender_pid <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    tr.sender_euid <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;

    <span style="color:#998;font-style:italic">// data为记录Media服务信息的Parcel对象
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">const</span> status_t err <span style="color:#000;font-weight:bold">=</span> data.errorCheck();
    <span style="color:#000;font-weight:bold">if</span> (err <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) {
        tr.data_size <span style="color:#000;font-weight:bold">=</span> data.ipcDataSize();  <span style="color:#998;font-style:italic">// mDataSize
</span><span style="color:#998;font-style:italic"></span>        tr.data.ptr.buffer <span style="color:#000;font-weight:bold">=</span> data.ipcData(); <span style="color:#998;font-style:italic">//mData
</span><span style="color:#998;font-style:italic"></span>        tr.offsets_size <span style="color:#000;font-weight:bold">=</span> data.ipcObjectsCount()<span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">sizeof</span>(binder_size_t); <span style="color:#998;font-style:italic">//mObjectsSize
</span><span style="color:#998;font-style:italic"></span>        tr.data.ptr.offsets <span style="color:#000;font-weight:bold">=</span> data.ipcObjects(); <span style="color:#998;font-style:italic">//mObjects
</span><span style="color:#998;font-style:italic"></span>    } <span style="color:#000;font-weight:bold">else</span> <span style="color:#900;font-weight:bold">if</span> (statusBuffer) {
        ...
    } <span style="color:#000;font-weight:bold">else</span> {
        <span style="color:#000;font-weight:bold">return</span> (mLastError <span style="color:#000;font-weight:bold">=</span> err);
    }
    
    <span style="color:#998;font-style:italic">//cmd=BC_TRANSACTION
</span><span style="color:#998;font-style:italic"></span>    mOut.writeInt32(cmd);        
    mOut.write(<span style="color:#000;font-weight:bold">&amp;</span>tr, <span style="color:#000;font-weight:bold">sizeof</span>(tr));  <span style="color:#998;font-style:italic">//写入binder_transaction_data数据
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> NO_ERROR;
}
</code></pre></td></tr></table>
</div>
</div><p>上面的handle值为用来标识，在注册服务和获取服务的过程中，目的端都是内核中的ServiceManager。</p>
<p>binder_transction_data是binder通信数据结构，最终是将Binder请求码和tr写入到mOut中。</p>
<p>接下来是waitForResponse()方法</p>
<h4 id="9ipcwaitforresponse">9.IPC.waitForResponse</h4>
<p>waitForResponse即IPCThreadState.transact中等待响应过程</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">tatus_t IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>waitForResponse(Parcel <span style="color:#000;font-weight:bold">*</span>reply, status_t <span style="color:#000;font-weight:bold">*</span>acquireResult)
{
    <span style="color:#458;font-weight:bold">int32_t</span> cmd;
    <span style="color:#458;font-weight:bold">int32_t</span> err;
    <span style="color:#000;font-weight:bold">while</span> (<span style="color:#099">1</span>) {
        <span style="color:#998;font-style:italic">//【见下文】
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> ((err<span style="color:#000;font-weight:bold">=</span>talkWithDriver()) <span style="color:#000;font-weight:bold">&lt;</span> NO_ERROR) <span style="color:#000;font-weight:bold">break</span>; 
        ...
        <span style="color:#000;font-weight:bold">if</span> (mIn.dataAvail() <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">continue</span>;

        cmd <span style="color:#000;font-weight:bold">=</span> mIn.readInt32();
        <span style="color:#000;font-weight:bold">switch</span> (cmd) {
            <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BR_TRANSACTION_COMPLETE</span>: ...
            <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BR_DEAD_REPLY</span>: ...
            <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BR_FAILED_REPLY</span>: ...
            <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BR_ACQUIRE_RESULT</span>: ...
            <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BR_REPLY</span>: ...
                <span style="color:#000;font-weight:bold">goto</span> finish;

            <span style="color:#000;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
                err <span style="color:#000;font-weight:bold">=</span> executeCommand(cmd);  
                <span style="color:#000;font-weight:bold">if</span> (err <span style="color:#000;font-weight:bold">!</span><span style="color:#000;font-weight:bold">=</span> NO_ERROR) <span style="color:#000;font-weight:bold">goto</span> finish;
                <span style="color:#000;font-weight:bold">break</span>;
        }
    }
    ...
    <span style="color:#000;font-weight:bold">return</span> err;
}
</code></pre></td></tr></table>
</div>
</div><p>在waitForResponse中，先执行BR_TRANSACTION_COMPLET。另外，目标进程收到事物后，处理处理BR_TRANSACTION事务。 然后发送给当前进程，再执行BR_REPLY命令。</p>
<p>talkWithDriver()</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t IPCThreadState<span style="color:#000;font-weight:bold">:</span><span style="color:#000;font-weight:bold">:</span>talkWithDriver(<span style="color:#458;font-weight:bold">bool</span> doReceive)
{
    ...
    binder_write_read bwr;
    <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">bool</span> needRead <span style="color:#000;font-weight:bold">=</span> mIn.dataPosition() <span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">=</span> mIn.dataSize();
    <span style="color:#000;font-weight:bold">const</span> size_t outAvail <span style="color:#000;font-weight:bold">=</span> (<span style="color:#000;font-weight:bold">!</span>doReceive <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">|</span> needRead) <span style="color:#000;font-weight:bold">?</span> mOut.dataSize() <span style="color:#000;font-weight:bold">:</span> <span style="color:#099">0</span>;

    bwr.write_size <span style="color:#000;font-weight:bold">=</span> outAvail;
    bwr.write_buffer <span style="color:#000;font-weight:bold">=</span> (uintptr_t)mOut.data();

    <span style="color:#000;font-weight:bold">if</span> (doReceive <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> needRead) {
        <span style="color:#998;font-style:italic">//接收数据缓冲区信息的填充。如果以后收到数据，就直接填在mIn中了。
</span><span style="color:#998;font-style:italic"></span>        bwr.read_size <span style="color:#000;font-weight:bold">=</span> mIn.dataCapacity();
        bwr.read_buffer <span style="color:#000;font-weight:bold">=</span> (uintptr_t)mIn.data();
    } <span style="color:#000;font-weight:bold">else</span> {
        bwr.read_size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
        bwr.read_buffer <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    }
    <span style="color:#998;font-style:italic">//当读缓冲和写缓冲都为空，则直接返回
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> ((bwr.write_size <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> (bwr.read_size <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">return</span> NO_ERROR;

    bwr.write_consumed <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    bwr.read_consumed <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    status_t err;
    <span style="color:#000;font-weight:bold">do</span> {
        <span style="color:#998;font-style:italic">//通过ioctl不停的读写操作，跟Binder Driver进行通信
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (ioctl(mProcess<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>mDriverFD, BINDER_WRITE_READ, <span style="color:#000;font-weight:bold">&amp;</span>bwr) <span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>)
            err <span style="color:#000;font-weight:bold">=</span> NO_ERROR;
        ...
    } <span style="color:#000;font-weight:bold">while</span> (err <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span>EINTR); <span style="color:#998;font-style:italic">//当被中断，则继续执行
</span><span style="color:#998;font-style:italic"></span>    ...
    <span style="color:#000;font-weight:bold">return</span> err;
}
</code></pre></td></tr></table>
</div>
</div><p>在talkWithDriver方法中，是真正与binder驱动进行交换数据的结构，操作mOut和mIn变量。</p>
<p>经过ioctl()经过系统调用后进入Binder内核.</p>
<h4 id="10总结">10.总结</h4>
<p>在这一小节中，我们以medie为例分析了Native注册服务和获取服务的过程。</p>
<ul>
<li>即首先获得BpServiceManager对象，在调用ServiceManager对应的addService和gitService方法。在注册服务时，还要将当前线程放入binder线程池中。</li>
<li>两个方法都会去调用BpBinder的transact方法，但它只是一个代理方法。最终起用IPCThreadState的transact方法。</li>
<li>IPCThreadState.transact方法中，首先会检查数据是否有误，通过ioctl和Binder内核进行数据传输。并等待响应。</li>
</ul>
<h3 id="四binder内核中的注册服务和获取服务">四.Binder内核中的注册服务和获取服务</h3>
<p>在上一节的最后，我们发现IPCThreadState通过ioctl和binder内核进行了通信。这一节中，我们看binder内核是如何处理注册服务和获取服务的。</p>
<p>ioctl -&gt; binder_ioctl -&gt; binder_ioctl_write_read</p>
<h4 id="1binder_ioctl_write_read">1.binder_ioctl_write_read</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">binder_ioctl_write_read</span>(<span style="color:#000;font-weight:bold">struct</span> file <span style="color:#000;font-weight:bold">*</span>filp,
                <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">int</span> cmd, <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">long</span> arg,
                <span style="color:#000;font-weight:bold">struct</span> binder_thread <span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">thread</span>)
{
    <span style="color:#000;font-weight:bold">struct</span> binder_proc <span style="color:#000;font-weight:bold">*</span>proc <span style="color:#000;font-weight:bold">=</span> filp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>private_data;
    <span style="color:#458;font-weight:bold">void</span> __user <span style="color:#000;font-weight:bold">*</span>ubuf <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">void</span> __user <span style="color:#000;font-weight:bold">*</span>)arg;
    <span style="color:#000;font-weight:bold">struct</span> binder_write_read bwr;

    <span style="color:#998;font-style:italic">//将用户空间bwr结构体拷贝到内核空间
</span><span style="color:#998;font-style:italic"></span>    copy_from_user(<span style="color:#000;font-weight:bold">&amp;</span>bwr, ubuf, <span style="color:#000;font-weight:bold">sizeof</span>(bwr));
    ...

    <span style="color:#000;font-weight:bold">if</span> (bwr.write_size <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span>) {
        <span style="color:#998;font-style:italic">//将数据放入目标进程[见下文]
</span><span style="color:#998;font-style:italic"></span>        ret <span style="color:#000;font-weight:bold">=</span> binder_thread_write(proc, <span style="color:#000;font-weight:bold">thread</span>,
                      bwr.write_buffer,
                      bwr.write_size,
                      <span style="color:#000;font-weight:bold">&amp;</span>bwr.write_consumed);
        ...
    }
    <span style="color:#000;font-weight:bold">if</span> (bwr.read_size <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span>) {
        <span style="color:#998;font-style:italic">//读取自己队列的数据 
</span><span style="color:#998;font-style:italic"></span>        ret <span style="color:#000;font-weight:bold">=</span> binder_thread_read(proc, <span style="color:#000;font-weight:bold">thread</span>, bwr.read_buffer,
             bwr.read_size,
             <span style="color:#000;font-weight:bold">&amp;</span>bwr.read_consumed,
             filp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>f_flags <span style="color:#000;font-weight:bold">&amp;</span> O_NONBLOCK);
        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>list_empty(<span style="color:#000;font-weight:bold">&amp;</span>proc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>todo))
            wake_up_interruptible(<span style="color:#000;font-weight:bold">&amp;</span>proc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>wait);
        ...
    }

    <span style="color:#998;font-style:italic">//将内核空间bwr结构体拷贝到用户空间
</span><span style="color:#998;font-style:italic"></span>    copy_to_user(ubuf, <span style="color:#000;font-weight:bold">&amp;</span>bwr, <span style="color:#000;font-weight:bold">sizeof</span>(bwr));
    ...
}   
</code></pre></td></tr></table>
</div>
</div><h4 id="2binder_thread_write">2.binder_thread_write</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">binder_thread_write</span>(<span style="color:#000;font-weight:bold">struct</span> binder_proc <span style="color:#000;font-weight:bold">*</span>proc,
            <span style="color:#000;font-weight:bold">struct</span> binder_thread <span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">thread</span>,
            binder_uintptr_t binder_buffer, size_t size,
            binder_size_t <span style="color:#000;font-weight:bold">*</span>consumed)
{
    uint32_t cmd;
    <span style="color:#458;font-weight:bold">void</span> __user <span style="color:#000;font-weight:bold">*</span>buffer <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">void</span> __user <span style="color:#000;font-weight:bold">*</span>)(uintptr_t)binder_buffer;
    <span style="color:#458;font-weight:bold">void</span> __user <span style="color:#000;font-weight:bold">*</span>ptr <span style="color:#000;font-weight:bold">=</span> buffer <span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">*</span>consumed;
    <span style="color:#458;font-weight:bold">void</span> __user <span style="color:#000;font-weight:bold">*</span>end <span style="color:#000;font-weight:bold">=</span> buffer <span style="color:#000;font-weight:bold">+</span> size;
    <span style="color:#000;font-weight:bold">while</span> (ptr <span style="color:#000;font-weight:bold">&lt;</span> end <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>return_error <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> BR_OK) {
        <span style="color:#998;font-style:italic">//拷贝用户空间的cmd命令，此时为BC_TRANSACTION
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (get_user(cmd, (uint32_t __user <span style="color:#000;font-weight:bold">*</span>)ptr)) <span style="color:#000;font-weight:bold">-</span>EFAULT;
        ptr <span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">sizeof</span>(uint32_t);
        <span style="color:#000;font-weight:bold">switch</span> (cmd) {
        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BC_TRANSACTION</span>:
        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BC_REPLY</span>: {
            <span style="color:#000;font-weight:bold">struct</span> binder_transaction_data tr;
            <span style="color:#998;font-style:italic">//拷贝用户空间的binder_transaction_data
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> (copy_from_user(<span style="color:#000;font-weight:bold">&amp;</span>tr, ptr, <span style="color:#000;font-weight:bold">sizeof</span>(tr)))   <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span>EFAULT;
            ptr <span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">sizeof</span>(tr);
            <span style="color:#998;font-style:italic">// 见下文
</span><span style="color:#998;font-style:italic"></span>            binder_transaction(proc, <span style="color:#000;font-weight:bold">thread</span>, <span style="color:#000;font-weight:bold">&amp;</span>tr, cmd <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> BC_REPLY);
            <span style="color:#000;font-weight:bold">break</span>;
        }
        ...
    }
    <span style="color:#000;font-weight:bold">*</span>consumed <span style="color:#000;font-weight:bold">=</span> ptr <span style="color:#000;font-weight:bold">-</span> buffer;
  }
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><h4 id="3binder_transaction">3.binder_transaction</h4>
<p>在经过内核中的调度后，最终调度到了binde_transaction方法中。binder_transaction方法代码非常长，所以仅展示和注册获取服务相关的操作。</p>
<p>对于flat_binder_object这个数据结构中，type类型</p>
<blockquote>
<p>1.当type等于BINDER_TYPE_BINDER或BINDER_TYPE_WEAK_BINDER类型时， 代表Server进程向ServiceManager进程注册服务，则创建binder_node对象；<br>
2.当type等于BINDER_TYPE_HANDLE或BINDER_TYPE_WEAK_HEANDLE类型时， 代表Client进程向Server进程请求代理，则创建binder_ref对象；<br>
3.当type等于BINDER_TYPE_FD类型时， 代表进程向另一个进程发送文件描述符，只打开文件，则无需创建任何对象。</p>
</blockquote>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">binder_transaction</span>(<span style="color:#000;font-weight:bold">struct</span> binder_proc <span style="color:#000;font-weight:bold">*</span>proc,
               <span style="color:#000;font-weight:bold">struct</span> binder_thread <span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">thread</span>,
               <span style="color:#000;font-weight:bold">struct</span> binder_transaction_data <span style="color:#000;font-weight:bold">*</span>tr, <span style="color:#458;font-weight:bold">int</span> reply){
    <span style="color:#000;font-weight:bold">struct</span> binder_transaction <span style="color:#000;font-weight:bold">*</span>t;
   	<span style="color:#000;font-weight:bold">struct</span> binder_work <span style="color:#000;font-weight:bold">*</span>tcomplete;
    ...

    <span style="color:#000;font-weight:bold">if</span> (reply) {
        ...
    }<span style="color:#000;font-weight:bold">else</span> {
        <span style="color:#000;font-weight:bold">if</span> (tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>target.handle) {
            ...
        } <span style="color:#000;font-weight:bold">else</span> {
            <span style="color:#998;font-style:italic">// handle=0则找到servicemanager实体
</span><span style="color:#998;font-style:italic"></span>            target_node <span style="color:#000;font-weight:bold">=</span> binder_context_mgr_node;
        }
        <span style="color:#998;font-style:italic">//target_proc为servicemanager进程
</span><span style="color:#998;font-style:italic"></span>        target_proc <span style="color:#000;font-weight:bold">=</span> target_node<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>proc;
    }

    <span style="color:#000;font-weight:bold">if</span> (target_thread) {
        ...
    } <span style="color:#000;font-weight:bold">else</span> {
        <span style="color:#998;font-style:italic">//找到servicemanager进程的todo队列
</span><span style="color:#998;font-style:italic"></span>        target_list <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">&amp;</span>target_proc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>todo;
        target_wait <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">&amp;</span>target_proc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>wait;
    }

    t <span style="color:#000;font-weight:bold">=</span> kzalloc(<span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#000;font-weight:bold">*</span>t), GFP_KERNEL);
    tcomplete <span style="color:#000;font-weight:bold">=</span> kzalloc(<span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#000;font-weight:bold">*</span>tcomplete), GFP_KERNEL);

    <span style="color:#998;font-style:italic">//非oneway的通信方式，把当前thread保存到transaction的from字段
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>reply <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">!</span>(tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>flags <span style="color:#000;font-weight:bold">&amp;</span> TF_ONE_WAY))
        t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>from <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">thread</span>;
    <span style="color:#000;font-weight:bold">else</span>
        t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>from <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>;

    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>sender_euid <span style="color:#000;font-weight:bold">=</span> task_euid(proc<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>tsk);
    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>to_proc <span style="color:#000;font-weight:bold">=</span> target_proc; <span style="color:#998;font-style:italic">//此次通信目标进程为servicemanager进程
</span><span style="color:#998;font-style:italic"></span>    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>to_thread <span style="color:#000;font-weight:bold">=</span> target_thread;
    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>code <span style="color:#000;font-weight:bold">=</span> tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>code;  <span style="color:#998;font-style:italic">//此次通信code = ADD_SERVICE_TRANSACTION
</span><span style="color:#998;font-style:italic"></span>    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>flags <span style="color:#000;font-weight:bold">=</span> tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>flags;  <span style="color:#998;font-style:italic">// 此次通信flags = 0
</span><span style="color:#998;font-style:italic"></span>    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>priority <span style="color:#000;font-weight:bold">=</span> task_nice(current);

    <span style="color:#998;font-style:italic">//从servicemanager进程中分配buffer
</span><span style="color:#998;font-style:italic"></span>    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>buffer <span style="color:#000;font-weight:bold">=</span> binder_alloc_buf(target_proc, tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data_size,
        tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>offsets_size, <span style="color:#000;font-weight:bold">!</span>reply <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> (t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>flags <span style="color:#000;font-weight:bold">&amp;</span> TF_ONE_WAY));

    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>buffer<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>allow_user_free <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>buffer<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>transaction <span style="color:#000;font-weight:bold">=</span> t;
    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>buffer<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>target_node <span style="color:#000;font-weight:bold">=</span> target_node;

    <span style="color:#000;font-weight:bold">if</span> (target_node)
        binder_inc_node(target_node, <span style="color:#099">1</span>, <span style="color:#099">0</span>, <span style="color:#0086b3">NULL</span>); <span style="color:#998;font-style:italic">//引用计数加1
</span><span style="color:#998;font-style:italic"></span>    offp <span style="color:#000;font-weight:bold">=</span> (binder_size_t <span style="color:#000;font-weight:bold">*</span>)(t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>buffer<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data <span style="color:#000;font-weight:bold">+</span> ALIGN(tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data_size, <span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)));

    <span style="color:#998;font-style:italic">//分别拷贝用户空间的binder_transaction_data中ptr.buffer和ptr.offsets到内核
</span><span style="color:#998;font-style:italic"></span>    copy_from_user(t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>buffer<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data,
        (<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span> __user <span style="color:#000;font-weight:bold">*</span>)(uintptr_t)tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data.ptr.buffer, tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data_size);
    copy_from_user(offp,
        (<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span> __user <span style="color:#000;font-weight:bold">*</span>)(uintptr_t)tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data.ptr.offsets, tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>offsets_size);

    off_end <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)offp <span style="color:#000;font-weight:bold">+</span> tr<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>offsets_size;

    <span style="color:#000;font-weight:bold">for</span> (; offp <span style="color:#000;font-weight:bold">&lt;</span> off_end; offp<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span>) {
        <span style="color:#000;font-weight:bold">struct</span> flat_binder_object <span style="color:#000;font-weight:bold">*</span>fp;
        fp <span style="color:#000;font-weight:bold">=</span> (<span style="color:#000;font-weight:bold">struct</span> flat_binder_object <span style="color:#000;font-weight:bold">*</span>)(t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>buffer<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data <span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">*</span>offp);
        off_min <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">*</span>offp <span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#000;font-weight:bold">struct</span> flat_binder_object);
        <span style="color:#000;font-weight:bold">switch</span> (fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type) {
            <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BINDER_TYPE_BINDER</span>:
            <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BINDER_TYPE_WEAK_BINDER</span>: { <span style="color:#998;font-style:italic">//注册服务
</span><span style="color:#998;font-style:italic"></span>              <span style="color:#000;font-weight:bold">struct</span> binder_ref <span style="color:#000;font-weight:bold">*</span>ref;
              <span style="color:#998;font-style:italic">//【见4.3.1】
</span><span style="color:#998;font-style:italic"></span>              <span style="color:#000;font-weight:bold">struct</span> binder_node <span style="color:#000;font-weight:bold">*</span>node <span style="color:#000;font-weight:bold">=</span> binder_get_node(proc, fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>binder);
              <span style="color:#000;font-weight:bold">if</span> (node <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>) {
                <span style="color:#998;font-style:italic">//服务所在进程 创建binder_node实体
</span><span style="color:#998;font-style:italic"></span>                node <span style="color:#000;font-weight:bold">=</span> binder_new_node(proc, fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>binder, fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>cookie);
                ...
              }
              <span style="color:#998;font-style:italic">//servicemanager进程binder_ref
</span><span style="color:#998;font-style:italic"></span>              ref <span style="color:#000;font-weight:bold">=</span> binder_get_ref_for_node(target_proc, node);
              ...
              <span style="color:#998;font-style:italic">//调整type为HANDLE类型
</span><span style="color:#998;font-style:italic"></span>              <span style="color:#000;font-weight:bold">if</span> (fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_BINDER)
                fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_HANDLE;
              <span style="color:#000;font-weight:bold">else</span>
                fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_WEAK_HANDLE;
              fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>binder <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
              fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle <span style="color:#000;font-weight:bold">=</span> ref<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>desc; <span style="color:#998;font-style:italic">//设置handle值
</span><span style="color:#998;font-style:italic"></span>              fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>cookie <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
              binder_inc_ref(ref, fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_HANDLE,
                       <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>todo);
            } <span style="color:#000;font-weight:bold">break</span>;
        
        
        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BINDER_TYPE_HANDLE</span>:
        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BINDER_TYPE_WEAK_HANDLE</span>: {
        <span style="color:#998;font-style:italic">//这是ServiceManager对处理完之后，获取服务
</span><span style="color:#998;font-style:italic"></span>          <span style="color:#000;font-weight:bold">struct</span> binder_ref <span style="color:#000;font-weight:bold">*</span>ref <span style="color:#000;font-weight:bold">=</span> binder_get_ref(proc, fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle,
                fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_HANDLE);
          ...
          <span style="color:#998;font-style:italic">//此时运行在servicemanager进程，故ref-&gt;node是指向服务所在进程的binder实体，
</span><span style="color:#998;font-style:italic"></span>          <span style="color:#998;font-style:italic">//而target_proc为请求服务所在的进程，此时并不相等。
</span><span style="color:#998;font-style:italic"></span>          <span style="color:#000;font-weight:bold">if</span> (ref<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>node<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>proc <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> target_proc) {
            <span style="color:#000;font-weight:bold">if</span> (fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_HANDLE)
              fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_BINDER;
            <span style="color:#000;font-weight:bold">else</span>
              fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_WEAK_BINDER;
            fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>binder <span style="color:#000;font-weight:bold">=</span> ref<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>node<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>ptr;
            fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>cookie <span style="color:#000;font-weight:bold">=</span> ref<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>node<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>cookie; <span style="color:#998;font-style:italic">//BBinder服务的地址
</span><span style="color:#998;font-style:italic"></span>            binder_inc_node(ref<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>node, fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_BINDER, <span style="color:#099">0</span>, <span style="color:#0086b3">NULL</span>);

          } <span style="color:#000;font-weight:bold">else</span> {
            <span style="color:#000;font-weight:bold">struct</span> binder_ref <span style="color:#000;font-weight:bold">*</span>new_ref;
            <span style="color:#998;font-style:italic">//请求服务所在进程并非服务所在进程，则为请求服务所在进程创建binder_ref
</span><span style="color:#998;font-style:italic"></span>            new_ref <span style="color:#000;font-weight:bold">=</span> binder_get_ref_for_node(target_proc, ref<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>node);
            fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>binder <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
            fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle <span style="color:#000;font-weight:bold">=</span> new_ref<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>desc; <span style="color:#998;font-style:italic">//重新赋予handle值
</span><span style="color:#998;font-style:italic"></span>            fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>cookie <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
            binder_inc_ref(new_ref, fp<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_HANDLE, <span style="color:#0086b3">NULL</span>);
          }
        } <span style="color:#000;font-weight:bold">break</span>;

        <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">BINDER_TYPE_FD</span>: ...
    }

    <span style="color:#000;font-weight:bold">if</span> (reply) {
        ..
    } <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>(t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>flags <span style="color:#000;font-weight:bold">&amp;</span> TF_ONE_WAY)) {
        <span style="color:#998;font-style:italic">//BC_TRANSACTION 且 非oneway,则设置事务栈信息
</span><span style="color:#998;font-style:italic"></span>        t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>need_reply <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
        t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>from_parent <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>transaction_stack;
        <span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>transaction_stack <span style="color:#000;font-weight:bold">=</span> t;
    } <span style="color:#000;font-weight:bold">else</span> {
        ...
    }

    <span style="color:#998;font-style:italic">//将BINDER_WORK_TRANSACTION添加到目标队列，本次通信的目标队列为target_proc-&gt;todo
</span><span style="color:#998;font-style:italic"></span>    t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>work.type <span style="color:#000;font-weight:bold">=</span> BINDER_WORK_TRANSACTION;
    list_add_tail(<span style="color:#000;font-weight:bold">&amp;</span>t<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>work.entry, target_list);

    <span style="color:#998;font-style:italic">//将BINDER_WORK_TRANSACTION_COMPLETE添加到当前线程的todo队列
</span><span style="color:#998;font-style:italic"></span>    tcomplete<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span> BINDER_WORK_TRANSACTION_COMPLETE;
    list_add_tail(<span style="color:#000;font-weight:bold">&amp;</span>tcomplete<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>entry, <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">thread</span><span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>todo);

    <span style="color:#998;font-style:italic">//唤醒等待队列，本次通信的目标队列为target_proc-&gt;wait
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (target_wait)
        wake_up_interruptible(target_wait);
    <span style="color:#000;font-weight:bold">return</span>;
}
</code></pre></td></tr></table>
</div>
</div><h4 id="4总结">4.总结</h4>
<p>在binder内核中，最终调用binder内核的binder_transaction方法。在这其中，对于注册服务和获取服务有不同的处理。</p>
<p>对于注册服务：在服务所在的进程中创建该进程对应的binder实体,在ServiceManager中创建binder引用。
最后向servicemanager的binder_proc-&gt;todo添加BINDER_WORK_TRANSACTION事务。交给ServiceManager处理。</p>
<p>对于获取服务,binder内核会先将其发往ServiceManager中，ServiceManager处理完毕后，将其他type改为BINDER_TYPE_HANDLE。之后也是在binder_transaction中进行如下处理：</p>
<ul>
<li>当请求服务的进程与服务属于不同的进程，则为请求服务所在的进程创建一个binder引用，指向服务进程中的binder_nodr</li>
<li>请求服务的进程与服务属于同一进程是。不在创建新对象，而是引用计数+1.并修改type为BINDER_TYPE_BINDER或BINDER_TYPE_WEAK_BINDER。</li>
</ul>
<h3 id="五servicemanager中的注册服务和获取服务的">五.ServiceManager中的注册服务和获取服务的</h3>
<p>在上面binder内核中，当创建好对应的对象时，最后向servicemanager的binder_proc-&gt;todo添加BINDER_WORK_TRANSACTION事务。将对应的事件交给了servicemanager来继续处理。</p>
<h4 id="1svcmgr_handler">1.svcmgr_handler</h4>
<p>在上一篇博客中，我们知道ServiceManager中的注册服务和获取服务在svcmgr_handler方法中</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">svcmgr_handler</span>(<span style="color:#000;font-weight:bold">struct</span> binder_state <span style="color:#000;font-weight:bold">*</span>bs,
                   <span style="color:#000;font-weight:bold">struct</span> binder_transaction_data <span style="color:#000;font-weight:bold">*</span>txn,
                   <span style="color:#000;font-weight:bold">struct</span> binder_io <span style="color:#000;font-weight:bold">*</span>msg,
                   <span style="color:#000;font-weight:bold">struct</span> binder_io <span style="color:#000;font-weight:bold">*</span>reply)
{
 .....

    <span style="color:#000;font-weight:bold">switch</span>(txn<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>code) {
    <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SVC_MGR_GET_SERVICE</span>:
    <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SVC_MGR_CHECK_SERVICE</span>: <span style="color:#998;font-style:italic">//查找
</span><span style="color:#998;font-style:italic"></span>        s <span style="color:#000;font-weight:bold">=</span> bio_get_string16(msg, <span style="color:#000;font-weight:bold">&amp;</span>len); <span style="color:#998;font-style:italic">//服务名
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//根据名称查找相应服务 
</span><span style="color:#998;font-style:italic"></span>        handle <span style="color:#000;font-weight:bold">=</span> do_find_service(bs, s, len, txn<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>sender_euid, txn<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>sender_pid);
        <span style="color:#998;font-style:italic">//【见小节3.1.2】
</span><span style="color:#998;font-style:italic"></span>        bio_put_ref(reply, handle);
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;

    <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SVC_MGR_ADD_SERVICE</span>: <span style="color:#998;font-style:italic">//注册
</span><span style="color:#998;font-style:italic"></span>        s <span style="color:#000;font-weight:bold">=</span> bio_get_string16(msg, <span style="color:#000;font-weight:bold">&amp;</span>len); <span style="color:#998;font-style:italic">//服务名
</span><span style="color:#998;font-style:italic"></span>        handle <span style="color:#000;font-weight:bold">=</span> bio_get_ref(msg); <span style="color:#998;font-style:italic">//handle
</span><span style="color:#998;font-style:italic"></span>        allow_isolated <span style="color:#000;font-weight:bold">=</span> bio_get_uint32(msg) <span style="color:#000;font-weight:bold">?</span> <span style="color:#099">1</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#099">0</span>;
         <span style="color:#998;font-style:italic">//注册指定服务 
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (do_add_service(bs, s, len, handle, txn<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>sender_euid,
            allow_isolated, txn<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>sender_pid))
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
        <span style="color:#000;font-weight:bold">break</span>;

    <span style="color:#000;font-weight:bold">case</span> <span style="color:#900;font-weight:bold">SVC_MGR_LIST_SERVICES</span>: {  
        uint32_t n <span style="color:#000;font-weight:bold">=</span> bio_get_uint32(msg);

        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>svc_can_list(txn<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>sender_pid)) {
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
        }
        si <span style="color:#000;font-weight:bold">=</span> svclist;
        <span style="color:#000;font-weight:bold">while</span> ((n<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> si)
            si <span style="color:#000;font-weight:bold">=</span> si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>next;
        <span style="color:#000;font-weight:bold">if</span> (si) {
            bio_put_string16(reply, si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>name);
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
        }
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
    }
    <span style="color:#000;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
    }

    bio_put_uint32(reply, <span style="color:#099">0</span>);
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}

</code></pre></td></tr></table>
</div>
</div><h4 id="2注册服务">2.注册服务</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">do_add_service</span>(<span style="color:#000;font-weight:bold">struct</span> binder_state <span style="color:#000;font-weight:bold">*</span>bs,
                   <span style="color:#000;font-weight:bold">const</span> uint16_t <span style="color:#000;font-weight:bold">*</span>s, size_t len,
                   uint32_t handle, uid_t uid, <span style="color:#458;font-weight:bold">int</span> allow_isolated,
                   pid_t spid)
{
    <span style="color:#000;font-weight:bold">struct</span> svcinfo <span style="color:#000;font-weight:bold">*</span>si;

    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>handle <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">|</span> (len <span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">|</span> (len <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">127</span>))
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;

    <span style="color:#998;font-style:italic">//权限检查
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>svc_can_register(s, len, spid)) {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
    }

    <span style="color:#998;font-style:italic">//服务检索
</span><span style="color:#998;font-style:italic"></span>    si <span style="color:#000;font-weight:bold">=</span> find_svc(s, len);
    <span style="color:#000;font-weight:bold">if</span> (si) {
        <span style="color:#000;font-weight:bold">if</span> (si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle) {
            svcinfo_death(bs, si); <span style="color:#998;font-style:italic">//服务已注册时，释放相应的服务
</span><span style="color:#998;font-style:italic"></span>        }
        si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle <span style="color:#000;font-weight:bold">=</span> handle;
    } <span style="color:#000;font-weight:bold">else</span> {
        si <span style="color:#000;font-weight:bold">=</span> malloc(<span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#000;font-weight:bold">*</span>si) <span style="color:#000;font-weight:bold">+</span> (len <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">sizeof</span>(uint16_t));
        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>si) {  <span style="color:#998;font-style:italic">//内存不足，无法分配足够内存
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
        }
        si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle <span style="color:#000;font-weight:bold">=</span> handle;
        si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>len <span style="color:#000;font-weight:bold">=</span> len;
        memcpy(si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>name, s, (len <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">sizeof</span>(uint16_t)); <span style="color:#998;font-style:italic">//内存拷贝服务信息
</span><span style="color:#998;font-style:italic"></span>        si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>name[len] <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14"></span><span style="color:#d14">&#39;</span><span style="color:#d14">\0</span><span style="color:#d14">&#39;</span>;
        si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>death.func <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>) svcinfo_death;
        si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>death.ptr <span style="color:#000;font-weight:bold">=</span> si;
        si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>allow_isolated <span style="color:#000;font-weight:bold">=</span> allow_isolated;
        si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>next <span style="color:#000;font-weight:bold">=</span> svclist; <span style="color:#998;font-style:italic">// svclist保存所有已注册的服务
</span><span style="color:#998;font-style:italic"></span>        svclist <span style="color:#000;font-weight:bold">=</span> si;
    }

    <span style="color:#998;font-style:italic">//以BC_ACQUIRE命令，handle为目标的信息，通过ioctl发送给binder驱动
</span><span style="color:#998;font-style:italic"></span>    binder_acquire(bs, handle);
    <span style="color:#998;font-style:italic">//以BC_REQUEST_DEATH_NOTIFICATION命令的信息，通过ioctl发送给binder驱动，主要用于清理内存等收尾工作
</span><span style="color:#998;font-style:italic"></span>    binder_link_to_death(bs, handle, <span style="color:#000;font-weight:bold">&amp;</span>si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>death);
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>注册服务分为以下4部分的工作：</p>
<ul>
<li>权限检查:检查权限是否满足</li>
<li>服务检索：根据服务名来查询是否有匹配的服务。</li>
<li>释放服务：释放服务，当查询到已存在同名的服务，则先清理该服务信息，再将当前的服务加入到服务列表svclist(头插)</li>
<li>通知内核：最后通知binder驱动，完成注册。让驱动完成主要用于清理内存等收尾工作</li>
</ul>
<h4 id="3查询服务">3.查询服务</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">uint32_t <span style="color:#900;font-weight:bold">do_find_service</span>(<span style="color:#000;font-weight:bold">struct</span> binder_state <span style="color:#000;font-weight:bold">*</span>bs, <span style="color:#000;font-weight:bold">const</span> uint16_t <span style="color:#000;font-weight:bold">*</span>s, size_t len, uid_t uid, pid_t spid)
{
    <span style="color:#998;font-style:italic">//查询相应的服务 
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">struct</span> svcinfo <span style="color:#000;font-weight:bold">*</span>si <span style="color:#000;font-weight:bold">=</span> find_svc(s, len);

    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>si <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">!</span>si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle) {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
    }

    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>allow_isolated) {
        uid_t appid <span style="color:#000;font-weight:bold">=</span> uid <span style="color:#000;font-weight:bold">%</span> AID_USER;
        <span style="color:#998;font-style:italic">//检查该服务是否允许孤立于进程而单独存在
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (appid <span style="color:#000;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">=</span> AID_ISOLATED_START <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> appid <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">=</span> AID_ISOLATED_END) {
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
        }
    }

    <span style="color:#998;font-style:italic">//服务是否满足查询条件
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>svc_can_find(s, len, spid)) {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
    }
    <span style="color:#000;font-weight:bold">return</span> si<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle;
}
</code></pre></td></tr></table>
</div>
</div><p>在这里查询到目标服务，并返回对应的handle，查询成功后，在调用 bio_put_ref(reply, handle)方法,将handle封装到reply。</p>
<p><strong>bio_put_ref</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">bio_put_ref</span>(<span style="color:#000;font-weight:bold">struct</span> binder_io <span style="color:#000;font-weight:bold">*</span>bio, uint32_t handle) {
    <span style="color:#000;font-weight:bold">struct</span> flat_binder_object <span style="color:#000;font-weight:bold">*</span>obj;

    <span style="color:#000;font-weight:bold">if</span> (handle)<span style="color:#998;font-style:italic">//如果handle==0 即查找的是ServiceManager
</span><span style="color:#998;font-style:italic"></span>        obj <span style="color:#000;font-weight:bold">=</span> bio_alloc_obj(bio); <span style="color:#998;font-style:italic">//见下
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">else</span>
        obj <span style="color:#000;font-weight:bold">=</span> bio_alloc(bio, <span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#000;font-weight:bold">*</span>obj));<span style="color:#998;font-style:italic">//见下
</span><span style="color:#998;font-style:italic"></span>
    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>obj)
        <span style="color:#000;font-weight:bold">return</span>;

    obj<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>flags <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0x7f</span> <span style="color:#000;font-weight:bold">|</span> FLAT_BINDER_FLAG_ACCEPTS_FDS;
    obj<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>type <span style="color:#000;font-weight:bold">=</span> BINDER_TYPE_HANDLE; <span style="color:#998;font-style:italic">//返回的是HANDLE类型
</span><span style="color:#998;font-style:italic"></span>    obj<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>handle <span style="color:#000;font-weight:bold">=</span> handle;
    obj<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>cookie <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><p><strong>bio_alloc_obj</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">struct</span> flat_binder_object <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">bio_alloc_obj</span>(<span style="color:#000;font-weight:bold">struct</span> binder_io <span style="color:#000;font-weight:bold">*</span>bio)
{
    <span style="color:#000;font-weight:bold">struct</span> flat_binder_object <span style="color:#000;font-weight:bold">*</span>obj;
    obj <span style="color:#000;font-weight:bold">=</span> bio_alloc(bio, <span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#000;font-weight:bold">*</span>obj));<span style="color:#998;font-style:italic">//见下
</span><span style="color:#998;font-style:italic"></span>
    <span style="color:#000;font-weight:bold">if</span> (obj <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&amp;</span> bio<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>offs_avail) {
        bio<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>offs_avail<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">-</span>;
        <span style="color:#000;font-weight:bold">*</span>bio<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>offs<span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">=</span> ((<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>) obj) <span style="color:#000;font-weight:bold">-</span> ((<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>) bio<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data0);
        <span style="color:#000;font-weight:bold">return</span> obj;
    }
    bio<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>flags <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">=</span> BIO_F_OVERFLOW;
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;
}
</code></pre></td></tr></table>
</div>
</div><p><strong>bio_alloc</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">bio_alloc</span>(<span style="color:#000;font-weight:bold">struct</span> binder_io <span style="color:#000;font-weight:bold">*</span>bio, size_t size)
{
    size <span style="color:#000;font-weight:bold">=</span> (size <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">3</span>) <span style="color:#000;font-weight:bold">&amp;</span> (<span style="color:#000;font-weight:bold">~</span><span style="color:#099">3</span>);
    <span style="color:#000;font-weight:bold">if</span> (size <span style="color:#000;font-weight:bold">&gt;</span> bio<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data_avail) {
        bio<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>flags <span style="color:#000;font-weight:bold">|</span><span style="color:#000;font-weight:bold">=</span> BIO_F_OVERFLOW;
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#0086b3">NULL</span>;
    } <span style="color:#000;font-weight:bold">else</span> {
        <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>ptr <span style="color:#000;font-weight:bold">=</span> bio<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data;
        bio<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data <span style="color:#000;font-weight:bold">+</span><span style="color:#000;font-weight:bold">=</span> size;
        bio<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data_avail <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">=</span> size;
        <span style="color:#000;font-weight:bold">return</span> ptr;
    }
}
</code></pre></td></tr></table>
</div>
</div><h4 id="4-返回reply结果">4. 返回reply结果</h4>
<p>在查询成功后，最终通过调用binder_send_reply将reply(包含获取服务的结果)返回到binder内核中。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">binder_send_reply</span>(<span style="color:#000;font-weight:bold">struct</span> binder_state <span style="color:#000;font-weight:bold">*</span>bs, <span style="color:#000;font-weight:bold">struct</span> binder_io <span style="color:#000;font-weight:bold">*</span>reply, binder_uintptr_t buffer_to_free, <span style="color:#458;font-weight:bold">int</span> status) {
    <span style="color:#000;font-weight:bold">struct</span> {
        uint32_t cmd_free;
        binder_uintptr_t buffer;
        uint32_t cmd_reply;
        <span style="color:#000;font-weight:bold">struct</span> binder_transaction_data txn;
    } __attribute__((packed)) data;

    data.cmd_free <span style="color:#000;font-weight:bold">=</span> BC_FREE_BUFFER; <span style="color:#998;font-style:italic">//free buffer命令
</span><span style="color:#998;font-style:italic"></span>    data.buffer <span style="color:#000;font-weight:bold">=</span> buffer_to_free;
    data.cmd_reply <span style="color:#000;font-weight:bold">=</span> BC_REPLY; <span style="color:#998;font-style:italic">// reply命令
</span><span style="color:#998;font-style:italic"></span>    data.txn.target.ptr <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    data.txn.cookie <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    data.txn.code <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    <span style="color:#000;font-weight:bold">if</span> (status) {
        data.txn.flags <span style="color:#000;font-weight:bold">=</span> TF_STATUS_CODE;
        data.txn.data_size <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#458;font-weight:bold">int</span>);
        data.txn.offsets_size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
        data.txn.data.ptr.buffer <span style="color:#000;font-weight:bold">=</span> (uintptr_t)<span style="color:#000;font-weight:bold">&amp;</span>status;
        data.txn.data.ptr.offsets <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    } <span style="color:#000;font-weight:bold">else</span> {
        data.txn.flags <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
        data.txn.data_size <span style="color:#000;font-weight:bold">=</span> reply<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data <span style="color:#000;font-weight:bold">-</span> reply<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data0;
        data.txn.offsets_size <span style="color:#000;font-weight:bold">=</span> ((<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>) reply<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>offs) <span style="color:#000;font-weight:bold">-</span> ((<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>) reply<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>offs0);
        data.txn.data.ptr.buffer <span style="color:#000;font-weight:bold">=</span> (uintptr_t)reply<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>data0;
        data.txn.data.ptr.offsets <span style="color:#000;font-weight:bold">=</span> (uintptr_t)reply<span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">&gt;</span>offs0;
    }
    <span style="color:#998;font-style:italic">//向Binder驱动通信
</span><span style="color:#998;font-style:italic"></span>    binder_write(bs, <span style="color:#000;font-weight:bold">&amp;</span>data, <span style="color:#000;font-weight:bold">sizeof</span>(data));
}
</code></pre></td></tr></table>
</div>
</div><p>在binder_send_reply，将BC_FREE_BUFFER和BC_REPLY命令协议发送给Binder驱动，在向客户端发送reply. 其中data的数据区中保存的是TYPE为HANDLE.</p>
<p>之后就是上一节中，binder_transaction中获取服务那一步。</p>
<h3 id="六总结">六.总结</h3>
<p>在进行获取服务和注册服务时，首先要获取BpServiceManager，BpServiceManager继承接口IServiceManager，并且含有binder内核中ServiceManager的binder(handle = 0)。</p>
<p>在获取BpServiceManager时：</p>
<ul>
<li>首先获取ProcessState对象，并在其中打开binder驱动，调用mmap分配一块虚拟内存空间。</li>
<li>获取bpBinder时，就是ServiceManager的binder，</li>
<li>C++中的宏函数创建bpServiceManager对象。</li>
</ul>
<p>获取BpServiceManager之后，就可以调用对应的注册服务和获取服务方法，即addService和getService。之后都会去调用BpServiceManager中的BpBinadr的transact方法。</p>
<p>在BpBinder方法中，去调用了IPCThreadState的transact方法。在这个方法中，，首先会检查数据是否有误，通过ioctl和Binder内核进行数据传输。并等待响应。</p>
<p>之后就是内核对注册获取服务的处理。</p>
<p>在binder内核中，最终调用binder内核的binder_transaction方法。在这其中，对于注册服务和获取服务有不同的处理。</p>
<p>对于注册服务：在服务所在的进程中创建该进程对应的binder实体,在ServiceManager中创建binder引用。
最后向servicemanager的binder_proc-&gt;todo添加BINDER_WORK_TRANSACTION事务。交给ServiceManager处理。</p>
<p>在ServiceManager中，经过了如下过程，权限检查，服务检索，释放同名服务，添加新服务，通知内核。</p>
<p>对于获取服务,binder内核会先将其发往ServiceManager中，在ServiceManager中，查询完成后，将查询的handle封装到reply，并将其他ype改为BINDER_TYPE_HANDLE。在发送给内核。</p>
<p>之后也是在binder_transaction中进行如下处理：</p>
<ul>
<li>当请求服务的进程与服务属于不同的进程，则为请求服务所在的进程创建一个binder引用，指向服务进程中的binder_nodr</li>
<li>请求服务的进程与服务属于同一进程是。不在创建新对象，而是引用计数+1.并修改type为BINDER_TYPE_BINDER或BINDER_TYPE_WEAK_BINDER。</li>
</ul>
<h3 id="七参考资料">七.参考资料</h3>
<p><a href="http://gityuan.com/2015/11/07/binder-start-sm//">Binder系列3—启动ServiceManager</a><br>
<a href="http://gityuan.com/2015/11/08/binder-get-sm/">Binder系列4—获取ServiceManager</a><br>
<a href="http://gityuan.com/2015/11/14/binder-add-service/">Binder系列5—注册服务(addService)</a><br>
<a href="http://gityuan.com/2015/11/15/binder-get-service/">Binder系列6—获取服务(getService)</a></p>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="http://blog.bingtan.online">冰炭不投day</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="http://blog.bingtan.online/posts/AndroidIPC/Android%E4%B9%8BIPC5Binder2-Native%E5%B1%82%E5%88%86%E6%9E%90/">http://blog.bingtan.online/posts/AndroidIPC/Android%E4%B9%8BIPC5Binder2-Native%E5%B1%82%E5%88%86%E6%9E%90/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/posts/%E6%96%87%E7%AB%A0%E5%AF%BC%E8%88%AA/">文章导航</a></li>
        
        <li><a href="/posts/Android%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/Android%E4%B9%8B%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%8211Retrofit%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Android之网络请求11————Retrofit的源码分析</a></li>
        
        <li><a href="/posts/Android%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/Android%E4%B9%8B%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%8210Retrofit%E7%9A%84%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/">Android之网络请求10————Retrofit的进阶使用</a></li>
        
        <li><a href="/posts/Android%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/Android%E4%B9%8B%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%829Retrofit%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">Android之网络请求8————Retrofit的简单使用</a></li>
        
        <li><a href="/posts/Android%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/Android%E4%B9%8B%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%828OkHttp%E6%BA%90%E7%A0%815_%E7%BC%93%E5%AD%98%E7%9B%B8%E5%85%B3/">Android之网络请求8————OkHttp源码5:缓存相关</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            没有标签
            
        </div>
    </article>
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yourdiscussshortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "https://github.com/hsc396612325/HSCBlog/tree/gh-pages"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='http://blog.bingtan.online/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://blog.bingtan.online">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    
    <section class="widget">
        <h3 class="widget-title">文章目录</h3>
<ul class="widget-list">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一前言">一.前言</a></li>
    <li><a href="#二获取bpservicemanager">二.获取BpServiceManager</a>
      <ul>
        <li><a href="#1概述">1.概述</a></li>
        <li><a href="#2获取processstate对象">2.获取ProcessState对象</a></li>
        <li><a href="#3获取bpbinder对象">3.获取BpBinder对象</a></li>
        <li><a href="#4获取bpservicemanager">4.获取BpServiceManager</a></li>
        <li><a href="#5总结">5.总结</a></li>
      </ul>
    </li>
    <li><a href="#三native层的注册服务和获取服务">三.Native层的注册服务和获取服务</a>
      <ul>
        <li><a href="#1服务注册">1.服务注册</a></li>
        <li><a href="#2获取服务">2.获取服务</a></li>
        <li><a href="#3注册服务中writestrongbinderservice">3.注册服务中writeStrongBinder(service)</a></li>
        <li><a href="#4获取服务的readstrongbinder">4.获取服务的readStrongBinder()</a></li>
        <li><a href="#5bpbindertransact">5.BpBinder.transact</a></li>
        <li><a href="#6-ipcthreadstate的初始化">6. IPCThreadState的初始化</a></li>
        <li><a href="#7ipctransact方法">7.IPC.transact方法。</a></li>
        <li><a href="#8ipcwritetransactiondata">8.IPC.writeTransactionData</a></li>
        <li><a href="#9ipcwaitforresponse">9.IPC.waitForResponse</a></li>
        <li><a href="#10总结">10.总结</a></li>
      </ul>
    </li>
    <li><a href="#四binder内核中的注册服务和获取服务">四.Binder内核中的注册服务和获取服务</a>
      <ul>
        <li><a href="#1binder_ioctl_write_read">1.binder_ioctl_write_read</a></li>
        <li><a href="#2binder_thread_write">2.binder_thread_write</a></li>
        <li><a href="#3binder_transaction">3.binder_transaction</a></li>
        <li><a href="#4总结">4.总结</a></li>
      </ul>
    </li>
    <li><a href="#五servicemanager中的注册服务和获取服务的">五.ServiceManager中的注册服务和获取服务的</a>
      <ul>
        <li><a href="#1svcmgr_handler">1.svcmgr_handler</a></li>
        <li><a href="#2注册服务">2.注册服务</a></li>
        <li><a href="#3查询服务">3.查询服务</a></li>
        <li><a href="#4-返回reply结果">4. 返回reply结果</a></li>
      </ul>
    </li>
    <li><a href="#六总结">六.总结</a></li>
    <li><a href="#七参考资料">七.参考资料</a></li>
  </ul>
</nav>
</ul>
    </section>
    

    

    

    
   
    

    

    
    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://blog.bingtan.online/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="http://blog.bingtan.online">冰炭不投day的博客 By 冰炭不投day</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

</body>

</html>